<!-- ===================== PART 1/3 ===================== -->
<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Offerte SKY ‚Äì Dicembre</title>
<style>
  *{box-sizing:border-box}
  html,body{margin:0}

  :root{
    /* Palette chiara ispirata a Sky */
    --bg:#f5f7ff;
    --bg-soft:#ffffff;
    --card:#ffffff;
    --text:#111827;
    --sub:#5b6b8b;

    --muted:#eef2ff;
    --border:#dde3f7;

    --accent:#e6007e;      /* magenta Sky */
    --accent2:#0072ff;     /* blu Sky */
    --accent-soft:#eef3ff;

    --ring:0 0 0 2px rgba(0,114,255,.25);
    --shadow:0 10px 26px rgba(15,23,42,.10);
    --softshadow:0 6px 18px rgba(15,23,42,.08);
    --radius:18px;
  }

  body{
    background:
      radial-gradient(circle at 0% 0%, #f0f4ff 0, transparent 55%),
      radial-gradient(circle at 100% 0%, #ffe4f4 0, transparent 55%),
      linear-gradient(180deg,#f7f9ff,#f5f7ff 55%,#f0f4ff 100%);
    color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    font-size:16px;
    line-height:1.3;
    padding-bottom:88px;
  }

  .wrap{
    max-width:1100px;
    margin:20px auto 40px;
    padding:0 14px;
  }

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:16px;
  }

  .brand{
    display:flex;
    align-items:center;
    gap:12px;
  }

  .logo{
    width:88px;
    height:44px;
    border-radius:16px;
    background:
      linear-gradient(135deg,var(--accent),var(--accent2));
    box-shadow:0 10px 24px rgba(148,163,184,.45);
    position:relative;
  }

  .logo::after{
    content:"sky";
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    font-size:16px;
    color:#fff;
    text-transform:lowercase;
    letter-spacing:.04em;
  }

  h1{
    font-size:20px;
    margin:0;
    font-weight:800;
    letter-spacing:.03em;
    text-transform:uppercase;
    color:#111827;
  }

  header .btn.secondary{
    font-size:13px;
    padding:9px 14px;
    border-radius:999px;
    background:#ffffff;
    color:#1d4ed8;
    border:1px solid #c7d2fe;
    box-shadow:0 2px 8px rgba(15,23,42,.06);
  }
  header .btn.secondary:hover{
    background:#eef2ff;
  }

  /* CARD GENERALI */
  .form-card,
  .result-card,
  details.result-card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px 16px 14px;
  }

  .form-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:10px;
  }

  .form-title{
    display:flex;
    align-items:center;
    gap:8px;
  }

  .step{
    width:26px;
    height:26px;
    display:grid;
    place-items:center;
    border-radius:10px;
    background:radial-gradient(circle at 0% 0%,#ffffff 0,#ffe4f5 40%,#e6007e 100%);
    color:#111827;
    font-weight:900;
    font-size:12px;
    box-shadow:0 8px 18px rgba(148,163,184,.7);
  }

  .form-header .muted{
    font-size:13px;
    color:#6b7280;
  }

  .row{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }

  label{
    display:block;
    font-size:13px;
    color:#374151;
    margin:0 0 6px 2px;
    font-weight:600;
  }

  select{
    width:100%;
    background:#ffffff;
    color:var(--text);
    border:1px solid var(--border);
    padding:11px 14px;
    border-radius:12px;
    outline:none;
    font-size:15px;
    transition:box-shadow .18s ease,border-color .18s ease,background .18s ease,transform .08s ease;
    appearance:none;
    box-shadow:0 0 0 rgba(0,0,0,0);
  }

  select:focus{
    box-shadow:var(--ring);
    border-color:#93c5fd;
    background:#ffffff;
    transform:translateY(-1px);
  }

  select option{
    background:#ffffff;
    color:#111827;
  }

  /* CHIPS griglia responsiva (no overflow) */
  .chips{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
    gap:8px;
    padding:10px;
    background:var(--muted);
    border-radius:14px;
    border:1px solid var(--border);
  }

  .chips .chip{
    appearance:none;
    width:100%;
    text-align:center;
    border:1px solid #c7d2fe;
    padding:9px 10px;
    border-radius:999px;
    font-size:13px;
    background:#ffffff;
    box-shadow:0 4px 10px rgba(148,163,184,.4);
    white-space:normal;
    color:#1f2937;
    font-weight:500;
    cursor:pointer;
    transition:background .16s ease,transform .08s ease,border-color .16s ease,box-shadow .16s ease,color .16s ease;
  }

  .chips .chip:hover{
    border-color:#6366f1;
    box-shadow:0 6px 14px rgba(148,163,184,.55);
    transform:translateY(-1px);
  }

  .chip[aria-pressed="true"]{
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    border-color:transparent;
    color:#ffffff;
    font-weight:700;
    box-shadow:0 8px 18px rgba(129,140,248,.7);
  }

  .btn{
    background:linear-gradient(135deg,var(--accent2),var(--accent));
    color:#fff;
    border:none;
    padding:12px 16px;
    border-radius:999px;
    font-weight:800;
    cursor:pointer;
    box-shadow:0 10px 22px rgba(129,140,248,.6);
    font-size:15px;
    letter-spacing:.03em;
    text-transform:uppercase;
    transition:transform .08s ease,box-shadow .12s ease,filter .12s ease;
  }

  .btn:hover{
    transform:translateY(-1px);
    filter:brightness(1.03);
    box-shadow:0 12px 26px rgba(129,140,248,.7);
  }

  .btn:active{
    transform:translateY(0);
    box-shadow:0 8px 18px rgba(129,140,248,.5);
  }

  .btn.secondary{
    background:#ffffff;
    color:#1d4ed8;
    border:1px solid #c7d2fe;
    box-shadow:0 2px 8px rgba(148,163,184,.35);
    text-transform:none;
    letter-spacing:.01em;
    font-weight:600;
  }

  .btn.secondary:hover{
    background:#eef2ff;
    box-shadow:0 4px 12px rgba(148,163,184,.55);
  }

  .results{
    margin-top:14px;
  }

  .result-head{
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .result-name{
    font-size:19px;
    font-weight:900;
    color:#111827;
  }

  .kpis{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
    margin-top:12px;
  }

  .kpi{
    background:#f3f4ff;
    border:1px solid #d4ddff;
    border-radius:14px;
    padding:10px 12px;
    box-shadow:0 6px 14px rgba(148,163,184,.45);
  }
  .kpi .muted{
    color:#6b7280;
    font-size:13px;
  }
  .kpi b{
    font-size:18px;
    color:#111827;
  }

  .code{
    font-family:ui-monospace,monospace;
    background:#111827;
    border:1px solid #c7d2fe;
    padding:7px 10px;
    border-radius:10px;
    color:#e5ebff;
    font-size:13px;
  }

  .priceCard{
    background:radial-gradient(circle at 0 0,#e0e7ff 0,#ffffff 55%,#e5e7eb 100%);
    border:1px solid #c7d2fe;
    border-radius:16px;
    padding:12px 14px;
    display:flex;
    flex-direction:column;
    align-items:center;
    box-shadow:0 12px 26px rgba(148,163,184,.7);
    min-width:190px;
  }

  .priceValue{
    font-size:34px;
    line-height:1;
    font-weight:900;
    color:#111827;
  }

  .priceLabel{
    font-size:11px;
    color:#4b5563;
    letter-spacing:.16em;
    text-transform:uppercase;
    margin-top:4px;
  }

  /* di default nascosto: verr√† mostrato SOLO per 1100772 */
  .priceDetail{
    display:none;
    margin-top:8px;
    font-size:13px;
    color:#374151;
    text-align:center;
  }

  .badge{
    display:inline-block;
    padding:4px 9px;
    border-radius:999px;
    background:#e0f2fe;
    border:1px solid #bfdbfe;
    color:#1d4ed8;
    font-size:11px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.08em;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid #fed7aa;
    background:#fffbeb;
    color:#9a3412;
    font-size:11px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.08em;
  }

  .pill.glass{
    border-color:#bfdbfe;
    background:#eff6ff;
    color:#1d4ed8;
  }

  .notes{
    margin-top:10px;
    padding-top:10px;
    border-top:1px dashed #d1d5db;
    color:#4b5563;
    font-size:13px;
  }

  .recap{
    margin-top:10px;
    border:1px dashed #cbd5f5;
    background:#eef2ff;
    border-radius:14px;
    padding:12px 12px 10px;
  }

  .recap h4{
    margin:0 0 8px;
    font-size:14px;
    color:#111827;
    font-weight:700;
  }

  .recap-grid{
    display:grid;
    grid-template-columns:1fr auto;
    row-gap:8px;
    column-gap:10px;
    align-items:center;
  }

  .recap-label{
    color:#4b5563;
    font-size:12px;
  }

  .recap-value{
    font-weight:700;
    font-size:13px;
    color:#111827;
  }

  .recap-badges{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:10px;
  }

  .altContainer{
    margin-top:14px;
  }

  .offerAlt{
    background:#f9fafb;
    border:1px solid #d1d5db;
    border-radius:18px;
    padding:14px 16px;
    display:flex;
    flex-direction:column;
    gap:10px;
    box-shadow:0 10px 22px rgba(148,163,184,.6);
  }

  .offerAlt .head{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:12px;
  }

  .offerAlt .title{
    font-weight:800;
    font-size:15px;
    color:#111827;
  }

  .offerAlt .price{
    font-size:26px;
    font-weight:900;
    letter-spacing:.04em;
    color:#111827;
  }

  .offerAlt .meta{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    color:#4b5563;
    font-size:11px;
  }

  .offerAlt .meta span{
    background:#e5e7eb;
    border:1px solid #d1d5db;
    border-radius:999px;
    padding:5px 9px;
  }

  .offerAlt .notes{
    border-top:1px dashed #d1d5db;
    padding-top:8px;
    margin-top:2px;
    font-size:12px;
    color:#374151;
  }

  .mobileBar{
    position:fixed;
    left:0;
    right:0;
    bottom:0;
    z-index:30;
    background:linear-gradient(180deg,#ffffff,#e5e7eb);
    backdrop-filter:blur(10px);
    border-top:1px solid #d1d5db;
    box-shadow:0 -8px 20px rgba(148,163,184,.7);
    padding:10px 12px 12px;
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
  }
  .mobileBar .btn,
  .mobileBar .btn.secondary{
    width:100%;
  }

  .desktopOnly{display:none;}

  @media(min-width:760px){
    h1{font-size:22px;}
    .wrap{padding:0 18px;}
    .row{grid-template-columns:1fr 1fr;}
    .result-head{
      flex-direction:row;
      justify-content:space-between;
      align-items:flex-start;
    }
    .kpis{grid-template-columns:repeat(3,1fr);}
    .priceValue{font-size:40px;}
    body{padding-bottom:0;}
    .mobileBar{display:none;}
    .desktopOnly{display:inline-flex;}
  }

  /* --- CTA INSERISCI CONTRATTO --- */
  #contractCta{
    margin-top: 28px;
    padding: 18px 20px 22px;
    border-radius: 28px;
    border: 1px solid rgba(191, 204, 255, 0.9);
    background: radial-gradient(circle at 0 0,
                rgba(227,28,121,0.06),
                rgba(12,100,197,0.03) 45%,
                #ffffff 75%);
    box-shadow: 0 18px 40px rgba(15,23,42,0.12);
  }

  #contractCta .btn{
    max-width: 420px;
    margin: 0 auto;
    display: block;
    font-size: 15px;
    letter-spacing: .04em;
    text-transform: uppercase;
    padding: 14px 24px;
  }

  details.result-card{
    margin-top: 28px !important;
  }

  details.result-card > summary .muted {
    color: #ffffff !important;
  }

  #resRecesso{
    padding: 28px 24px;
  }

  #resRecesso .result-head{
    align-items: center;
  }

  #resRecesso .result-name{
    font-size: 24px;
  }

  #resRecesso .kpi b{
    font-size: 32px;
  }

  .promo-card{
    background:linear-gradient(135deg, rgba(77,137,255,0.06), rgba(227,28,121,0.03));
    border-style:dashed;
  }

  /* Nasconde il pulsante Dataset ovunque */
  #listinoBtn,
  #listinoBtnMb{
    display:none !important;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div><h1>PROMO IN CORSO</h1></div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn secondary" id="promoBtn" type="button">
          üëÅÔ∏è PROMO
        </button>
        <button class="btn secondary" id="resetBtn" aria-label="Pulisci campi" type="button">
          RESET
        </button>
      </div>
    </header>

    <!-- CARD PROMO ‚Äì TESTO AGGIORNATO -->
    <section class="result-card promo-card" id="promoCard" style="display:none; margin-bottom:14px;">
      <div style="font-size:14px; line-height:1.45;">
        <p>
          <strong>üõú 3P: TV + WiFi + Voce</strong><br>
          <em>Validit√† promo: fino al 31 dicembre ¬∑ 18 mesi ¬∑ attivazione 19‚Ç¨</em>
        </p>
        <ul style="margin:4px 0 8px 18px; padding:0;">
          <li>3P base (Sky TV + WiFi) a <strong>29,90‚Ç¨</strong>/mese.</li>
          <li>3P + <strong>Cinema</strong> a <strong>35,90‚Ç¨</strong>/mese.</li>
          <li>3P + <strong>Sport</strong> a <strong>35,90‚Ç¨</strong>/mese.</li>
        </ul>

        <p><strong>üì∫ Only TV</strong></p>
        <ul style="margin:4px 0 8px 18px; padding:0;">
          <li>
            üé• <strong>Sky TV + Netflix</strong> a
            <strong>15,99‚Ç¨</strong>/mese per <strong>18 mesi</strong> ¬∑
            validit√† <strong>16 dicembre 2025 ‚Äì 7 gennaio 2026</strong> (no backlog) ¬∑
            Cod. promo <strong>1100766</strong>.
          </li>
          <li>
            üé•üçø <strong>Sky TV + Netflix + Sky Cinema + UHD</strong>
            a <strong>15,99‚Ç¨</strong>/mese per i <strong>primi 6 mesi</strong>,
            poi <strong>24,99‚Ç¨</strong>/mese per i <strong>restanti 12 mesi</strong> ¬∑
            validit√† <strong>16 dicembre 2025 ‚Äì 7 gennaio 2026</strong> (no backlog) ¬∑
            Cod. promo <strong>1100772</strong>.<br>
            <strong>Attenzione:</strong> il canone di <strong>15,99‚Ç¨</strong> vale solo per i primi 6 mesi.
          </li>
          <li>
            üçø‚öΩÔ∏è <strong>Sky TV + Sky Cinema + Sky Calcio</strong>
            a <strong>19,99‚Ç¨</strong>/mese per <strong>18 mesi</strong> ¬∑
            validit√† <strong>16 dicembre 2025 ‚Äì 7 gennaio 2026</strong> (no backlog) ¬∑
            Cod. promo <strong>1100739</strong>.
          </li>
        </ul>

        <p><strong>üõú Only WiFi &amp; WiFi Business</strong></p>
        <ul style="margin:4px 0 8px 18px; padding:0;">
          <li>Sky WiFi privati: profilo standard e profilo <strong>Open Fiber</strong> invariati.</li>
          <li>WiFi Business <strong>Sky WiFi BB</strong> a 24,50‚Ç¨ + IVA.</li>
          <li>Nuova promo WiFi Business <strong>Open Fiber</strong> a
              <strong>21,50‚Ç¨ + IVA</strong>/mese (12 mesi), con attivazione 29‚Ç¨ + IVA,
              esposta come l&rsquo;offerta privati su copertura OF.</li>
        </ul>

        <p style="margin-top:4px;">
          Le logiche per aggiungere pacchetti TV e Netflix restano invariate rispetto al listino Sky Smart.
        </p>
      </div>
    </section>

    <!-- ===== FORM ===== -->
    <section class="form-card" id="formCard" aria-labelledby="formTitle">
      <div class="form-header">
        <div class="form-title">
          <span class="step">1</span>
          <b id="formTitle">Dati di richiesta</b>
        </div>
        <div class="muted" style="font-size:13px;color:#5b6b8b">
          Compila i campi e premi <b>Calcola offerta</b>.
        </div>
      </div>

      <div class="row">
        <div>
          <label for="tipoCliente">Tipologia cliente</label>
          <select id="tipoCliente">
            <option value="" selected disabled>Seleziona‚Ä¶</option>
            <option value="privato">Privato</option>
            <option value="business">Business</option>
          </select>
        </div>
        <div>
          <label for="offerta">Offerta richiesta</label>
          <select id="offerta">
            <option value="" selected disabled>Seleziona‚Ä¶</option>
            <option value="only_tv">Only TV</option>
            <option value="wifi">Sky Wifi</option>
            <option value="wifi_tv">Sky Wifi + TV (3P)</option>
            <option value="wifi_tv_glass">Sky wifi + Tv con GLASS (4P)</option>
          </select>
        </div>
      </div>

      <div id="voiceBlock" style="display:none; margin-top:10px;">
        <label>Opzione Voce (solo per Sky Wifi o 3P)</label>
        <div class="chips" id="chipsVoce" aria-label="Seleziona opzione voce">
          <button class="chip" data-group="voce" data-value="consumo" aria-pressed="false">Voce a consumo</button>
          <button class="chip" data-group="voce" data-value="unlimited" aria-pressed="false">Voce Unlimited</button>
        </div>
      </div>

      <div id="tvBlock" style="display:none; margin-top:10px;">
        <div class="row">
          <div>
            <label>Pacchetti TV</label>
            <div class="chips" id="chipsTV" aria-label="Seleziona pacchetti TV">
              <button class="chip" data-group="tv" data-value="calcio" aria-pressed="false">Calcio</button>
              <button class="chip" data-group="tv" data-value="sport"  aria-pressed="false">Sport</button>
              <button class="chip" data-group="tv" data-value="cinema" aria-pressed="false">Cinema</button>
              <button class="chip" data-group="tv" data-value="kids"   aria-pressed="false">Kids</button>
              <button class="chip" data-group="tv" data-value="uhd"    aria-pressed="false">UHD/4K</button>
            </div>
          </div>
          <div>
            <label>Netflix</label>
            <div class="chips" id="chipsNF" aria-label="Seleziona Netflix">
              <button class="chip" data-group="nf" data-value="none"     aria-pressed="true">Nessuno</button>
              <button class="chip" data-group="nf" data-value="base"     aria-pressed="false" title="2 schermi in HD">Standard con</button>
              <button class="chip" data-group="nf" data-value="standard" aria-pressed="false" title="2 schermi in HD">Standard</button>
              <button class="chip" data-group="nf" data-value="premium"  aria-pressed="false" title="4 schermi in 4K">Premium</button>
            </div>
            <div style="margin-top:6px;font-size:12px;color:#55637f">
              Netflix:
              <b>Standard con pubblicit√†</b> = 4,99‚Ç¨/mese ¬∑ 2 schermi in HD ¬∑
              <b>Standard</b> = 11,99‚Ç¨/mese ¬∑ 2 schermi in HD ¬∑
              <b>Premium</b> = 17,99‚Ç¨/mese ¬∑ 4 schermi in 4K.
            </div>
          </div>
        </div>
        <div class="muted" style="margin-top:6px;font-size:13px;color:#55637f">
          Seleziona i pacchetti desiderati. Le promo TV/3P vengono proposte automaticamente.
        </div>
      </div>

      <!-- Desktop buttons (su mobile si usa la sticky bar) -->
      <div class="row" style="margin-top:10px">
        <div></div>
        <div style="text-align:right;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn desktopOnly" id="calcBtn">Calcola offerta</button>
        </div>
      </div>
    </section>

    <!-- ===== RESULTS ===== -->
    <section class="results" id="results">
      <div class="result-card" id="noResult">
        Nessun risultato ancora. Compila i campi sopra e premi <b>Calcola offerta</b>.
      </div>

      <div class="result-card" id="result" style="display:none">
        <div class="result-head">
          <div>
            <div class="muted" style="font-size:13px;color:#5b6b8b">Promo consigliata</div>
            <div class="result-name" id="bestName">-</div>
            <div id="formulaBox" class="badge" style="display:none;margin-top:8px"></div>
          </div>
          <div>
            <div class="priceCard">
              <div class="priceValue" id="priceAmount">‚Äî</div>
              <div class="priceLabel">CANONE MENSILE</div>
              <div id="priceDetail" class="priceDetail"></div>
            </div>
          </div>
        </div>

        <div id="recapBox" class="recap" style="display:none"></div>

        <div class="kpis">
          <div class="kpi">
            <div class="muted">Costo di attivazione</div>
            <b id="attivazione">-</b>
          </div>
          <div class="kpi">
            <div class="muted">Codice attivazione</div>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
              <span class="code" id="codice">-</span>
              <button class="btn secondary" id="copyCode">Copia</button>
            </div>
          </div>
          <div class="kpi" id="glassKpi" style="display:none">
            <div class="muted">Sky Glass ‚Äì opzioni di acquisto</div>
            <b id="glassKpiText">‚Äî</b>
          </div>
          <div class="kpi">
            <div class="muted">Scadenza promo</div>
            <b id="scadenza">-</b>
          </div>
        </div>
        <div class="notes" id="note"></div>

        <!-- Composizione offerta -->
        <section class="recap" id="compositionBox" style="display:none; margin-top:14px;">
          <h4>Composizione offerta</h4>
          <div class="recap-grid">
            <div class="recap-label">Sky TV / Bundle</div>
            <div class="recap-value" id="compBundle">‚Äî</div>

            <div class="recap-label">+ Pacchetti / Opzioni</div>
            <div class="recap-value" id="compPacks">‚Äî</div>

            <div class="recap-label">Dispositivo</div>
            <div class="recap-value" id="compDevice">‚Äî</div>

            <div class="recap-label">Attivazione</div>
            <div class="recap-value" id="compActivation">‚Äî</div>

            <div class="recap-label">Vincolo (mesi)</div>
            <div class="recap-value" id="compVincolo">‚Äî</div>

            <div class="recap-label">Durata offerta (mesi)</div>
            <div class="recap-value" id="compDurata">‚Äî</div>
          </div>

          <div style="margin-top:12px;">
            <span class="badge">PROMO DEL MOMENTO</span>
          </div>
        </section>

        <!-- CTA per Sky Glass -->
        <div id="glassCtaWrapper" style="display:none; margin-top:12px; text-align:right;">
          <button class="btn secondary" id="toggleGlassBtn" type="button">Aggiungi Sky Glass</button>
        </div>

        <!-- Sezione Sky Glass -->
        <section class="recap" id="glassBox" style="display:none; margin-top:10px;">
          <h4>Sky Glass ‚Äì opzioni di acquisto</h4>
          <div class="recap-grid" style="row-gap:10px;">
            <div class="recap-label">Taglia dispositivo</div>
            <div class="recap-value">
              <div class="chips" id="chipsGlassSize" aria-label="Seleziona taglia Sky Glass">
                <button class="chip" data-group="glass_size" data-value="43" aria-pressed="true">Sky Glass 43"</button>
                <button class="chip" data-group="glass_size" data-value="55" aria-pressed="false">Sky Glass 55"</button>
              </div>
            </div>
            <div class="recap-label">Modalit√† di pagamento</div>
            <div class="recap-value">
              <div class="chips" id="chipsGlassPlan" aria-label="Seleziona modalit√† pagamento Sky Glass">
                <button class="chip" data-group="glass_plan" data-value="unico" aria-pressed="true">Pagamento unico</button>
                <button class="chip" data-group="glass_plan" data-value="rate48" aria-pressed="false">Rate 48 mesi</button>
                <button class="chip" data-group="glass_plan" data-value="rate12" aria-pressed="false">Rate 12 mesi</button>
              </div>
            </div>
          </div>

          <div class="recap-grid" style="row-gap:8px; margin-top:10px;">
            <div class="recap-label">Canone offerta</div>
            <div class="recap-value" id="glassPromoMonthly">‚Äî</div>

            <div class="recap-label">Rata Sky Glass</div>
            <div class="recap-value" id="glassRateMonthly">‚Äî</div>

            <div class="recap-label">Totale mensile (promo + Glass)</div>
            <div class="recap-value" id="glassTotalMonthly">‚Äî</div>
          </div>

          <div class="notes" id="glassNote">
            Sky Glass 43" ¬∑ pagamento unico 399‚Ç¨ (scontato da 651‚Ç¨).
          </div>
        </section>

        <!-- Alternativa WiFi (Open Fiber / Business OF) -->
        <div id="wifiAlternatives" class="altContainer" style="display:none"></div>
      </div>

      <div class="result-card" id="contractCta" style="display:none">
        <a class="btn" href="http://myspace.e2kdistribution.com/" target="_blank" rel="noopener" style="width:100%">
          INSERISCI CONTRATTO
        </a>
      </div>
    </section>

    <!-- ===== STICKY MOBILE BAR ===== -->
    <div class="mobileBar" aria-hidden="false">
      <button class="btn secondary" id="listinoBtnMb">Dataset</button>
      <button class="btn" id="calcBtnMb">Calcola offerta</button>
    </div>

    <!-- ===== RECESSO + DATASET ===== -->
    <details class="result-card" style="margin-top:12px">
      <summary class="btn" style="list-style:none;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
        Calcolo costi di recesso (Privato)
        <span class="muted" style="font-size:13px;color:#5b6b8b">tocca per aprire</span>
      </summary>
      <div style="padding-top:10px">
        <div class="row">
          <div>
            <label>Mesi trascorsi dall'attivazione</label>
            <select id="mesiTrascorsi">
              <option value="" selected disabled>Seleziona mese‚Ä¶</option>
              <option value="1">1¬∞</option><option value="2">2¬∞</option><option value="3">3¬∞</option>
              <option value="4">4¬∞</option><option value="5">5¬∞</option><option value="6">6¬∞</option>
              <option value="7">7¬∞</option><option value="8">8¬∞</option><option value="9">9¬∞</option>
              <option value="10">10¬∞</option><option value="11">11¬∞</option><option value="12">12¬∞</option>
              <option value="13">13¬∞</option><option value="14">14¬∞</option><option value="15">15¬∞</option>
              <option value="16">16¬∞</option><option value="17">17¬∞</option><option value="18">18¬∞</option>
            </select>
          </div>
          <div>
            <label>Numero pacchetti TV attivi</label>
            <select id="nPacchetti">
              <option value="" selected disabled>Seleziona configurazione‚Ä¶</option>
              <option value="tv">Sky TV</option>
              <option value="tv1">Sky TV + 1 pack</option>
              <option value="tv2">Sky TV + 2 pack</option>
              <option value="tv3">Sky TV + 3 pack</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="muted" style="color:#5b6b8b">
            I valori corrispondono al grafico ufficiale. Seleziona mese e configurazione, poi calcola.
          </div>
          <div style="text-align:right">
            <button class="btn" id="calcRecesso">Calcola recesso</button>
          </div>
        </div>
        <div class="result-card" id="resRecesso" style="display:none;margin-top:10px">
          <div class="result-head">
            <div class="result-name">Totale recesso</div>
            <div class="kpi"><b id="totRecesso">‚Ç¨ 0,00</b></div>
          </div>
          <div class="notes" id="detailRecesso"></div>
        </div>
      </div>
    </details>

    <dialog id="datasetDlg" style="border:none;border-radius:16px;max-width:920px;width:92%;background:#ffffff;color:#111827;">
      <div style="padding:14px 14px 8px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)">
        <b>Dataset promo (interno) ¬∑ v4.6</b>
        <button class="btn secondary" onclick="this.closest('dialog').close()">Chiudi</button>
      </div>
      <div style="padding:12px 14px 18px;max-height:60vh;overflow:auto">
        <pre id="datasetPre" style="white-space:pre-wrap;font-size:12px;line-height:1.35;background:#fafcff;border:1px solid var(--border);padding:12px;border-radius:12px"></pre>
        <div class="muted" style="margin-top:8px;font-size:12px;color:#5b6b8b">
          Nota: scelta promo Only TV ottimizzata sul costo totale 18 mesi (include step 6+12 per 1100772).
        </div>
      </div>
    </dialog>
  </div>

  <script>
  <!-- ===================== PART 2/3 ===================== -->
  (function(){
    const qs  = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const formatEUR = n => new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(n);
  
    /* === Netflix === */
    const NF_LABEL = { base:'Standard con pubblicit√†', standard:'Standard', premium:'Premium' };
    const nfLabel  = k => NF_LABEL[k] || k;
  
    /* === Label pacchetti === */
    const PACK_LABEL = { calcio:'Calcio', sport:'Sport', cinema:'Cinema', kids:'Kids', uhd:'UHD/4K' };
  
    /* === Listino base TV === */
    const LISTINO = {
      base:{ sky_tv:14.90, pacchetti:{ cinema:10.00, sport:22.90, calcio:8.00, kids:5.00, uhd:5.00 } }
    };
  
    /* Upcharge Netflix (valori mensili) */
    const NF_MONTHLY = { base:4.99, standard:11.99, premium:17.99 };
  
    /* === Sky Glass ‚Äì configurazioni acquisto === */
    const GLASS = {
      '43': {
        unico:{ title:'Sky Glass 43" ‚Äì pagamento unico', desc:'399‚Ç¨ (scontato da 651‚Ç¨)', summary:'Sky Glass 43" ¬∑ pagamento unico 399‚Ç¨ (scontato da 651‚Ç¨)', monthly:0 },
        rate48:{ title:'Sky Glass 43" ‚Äì rate 48 mesi', desc:'anticipo 15‚Ç¨ + 48 rate da 8‚Ç¨', summary:'Sky Glass 43" ¬∑ anticipo 15‚Ç¨ + 48 rate da 8‚Ç¨', monthly:8 },
        rate12:{ title:'Sky Glass 43" ‚Äì rate 12 mesi', desc:'anticipo 15‚Ç¨ + 12 rate da 32‚Ç¨', summary:'Sky Glass 43" ¬∑ anticipo 15‚Ç¨ + 12 rate da 32‚Ç¨', monthly:32 }
      },
      '55': {
        unico:{ title:'Sky Glass 55" ‚Äì pagamento unico', desc:'599‚Ç¨ (scontato da 987‚Ç¨)', summary:'Sky Glass 55" ¬∑ pagamento unico 599‚Ç¨ (scontato da 987‚Ç¨)', monthly:0 },
        rate48:{ title:'Sky Glass 55" ‚Äì rate 48 mesi', desc:'anticipo 23‚Ç¨ + 48 rate da 12‚Ç¨', summary:'Sky Glass 55" ¬∑ anticipo 23‚Ç¨ + 48 rate da 12‚Ç¨', monthly:12 },
        rate12:{ title:'Sky Glass 55" ‚Äì rate 12 mesi', desc:'anticipo 23‚Ç¨ + 12 rate da 48‚Ç¨', summary:'Sky Glass 55" ¬∑ anticipo 23‚Ç¨ + 12 rate da 48‚Ç¨', monthly:48 }
      }
    };
  
    /* === PROMO AGGIORNATE === */
    const PROMO = {
      /* ---- Only TV ---- */
      tvOnly:[
        {
          id:'TV_NF_1599',
          name:'Sky TV + Netflix',
          match:(s,nf)=> (nf === 'base' || nf === 'standard' || nf === 'premium' || nf === 'none'),
          price:'15,99‚Ç¨',
          priceValue:15.99,
          includesNetflixBase:true,
          attivazione:'Stream 19‚Ç¨',
          codice:'1100766',
          scadenza:'07/01/2026 (no backlog)',
          durata:'18 mesi',
          note:'Promo Sky TV + Netflix a 15,99‚Ç¨/mese per 18 mesi. Valida dal 16 dicembre 2025 al 7 gennaio 2026, senza backlog. Codice promo 1100766.'
        },
        {
          id:'TV_NF_CINEMA_UHD_STEP',
          name:'Sky TV + Netflix + Cinema + UHD',
          match:(s,nf)=> (nf === 'base' || nf === 'standard' || nf === 'premium' || nf === 'none') && s.has('cinema'),
          price:'15,99‚Ç¨ ‚Üí 24,99‚Ç¨',
          priceValue:15.99, // canone iniziale (primi 6 mesi)
          phases:[{months:6,price:15.99},{months:12,price:24.99}],
          priceDetail:'15,99‚Ç¨/mese per i primi 6 mesi, poi 24,99‚Ç¨/mese per i restanti 12 mesi (totale 18 mesi).',
          included:['cinema','uhd'],
          includesNetflixBase:true,
          attivazione:'Stream 19‚Ç¨',
          codice:'1100772',
          scadenza:'07/01/2026 (no backlog)',
          durata:'18 mesi (6 + 12)',
          note:'Promo Sky TV + Netflix + Sky Cinema + UHD: 15,99‚Ç¨/mese per i primi 6 mesi, poi 24,99‚Ç¨/mese per i restanti 12 mesi (totale 18 mesi). Valida dal 16 dicembre 2025 al 7 gennaio 2026, senza backlog. Codice promo 1100772.'
        },
        {
          id:'TV_CINEMA_CALCIO',
          name:'Sky TV + Cinema + Calcio',
          match:(s,nf)=> s.has('cinema') && s.has('calcio'),
          price:'19,99‚Ç¨',
          priceValue:19.99,
          included:['cinema','calcio'],
          attivazione:'Stream 19‚Ç¨',
          codice:'1100739',
          scadenza:'07/01/2026 (no backlog)',
          durata:'18 mesi',
          note:'Promo Sky TV + Sky Cinema + Sky Calcio a 19,99‚Ç¨/mese per 18 mesi. Valida dal 16 dicembre 2025 al 7 gennaio 2026, senza backlog. Codice promo 1100739.'
        }
      ],
  
      /* ---- 3P ---- */
      threeP:[
        {
          id:'3P_BASE',
          name:'3P base (Sky TV + WiFi)',
          price:'29,90‚Ç¨',
          priceValue:29.90,
          attivazione:'Stream 19‚Ç¨ ‚Äì WiFi Gratis',
          codiceVoce:{consumo:'1300207', unlimited:'1300208'},
          scadenza:'31/12/2025',
          durata:'18 mesi',
          note:'Pacchetti aggiuntivi a listino; Netflix opzionale.'
        },
        {
          id:'3P_SPORT',
          name:'3P + Sport',
          price:'35,90‚Ç¨',
          priceValue:35.90,
          attivazione:'Stream 19‚Ç¨ ‚Äì WiFi Gratis',
          codiceVoce:{consumo:'1300201', unlimited:'1300202'},
          scadenza:'31/12/2025',
          durata:'18 mesi',
          included:['sport'],
          note:'Aggiunte: Cinema 10‚Ç¨, Kids 5‚Ç¨, UHD/4K 5‚Ç¨, Netflix opzionale.'
        },
        {
          id:'3P_CINEMA',
          name:'3P + Cinema',
          price:'35,90‚Ç¨',
          priceValue:35.90,
          attivazione:'Stream 19‚Ç¨ ‚Äì WiFi Gratis',
          codiceVoce:{consumo:'1300197', unlimited:'1300198'},
          scadenza:'31/12/2025',
          durata:'18 mesi',
          included:['cinema'],
          note:'Aggiunte: Sport 22,90‚Ç¨, Kids 5‚Ç¨, UHD/4K 5‚Ç¨, Netflix opzionale.'
        }
      ],
  
      /* ---- WiFi Privati ---- */
      wifi:[
        { id:'WIFI_MAIN', name:'Sky WiFi (Only WiFi ¬∑ Senza vincoli)',
          match:()=>true,
          price:'25,90‚Ç¨', priceValue:25.90,
          attivazione:'29‚Ç¨',
          codiceVoce:{consumo:'8122', unlimited:'8123'},
          scadenza:'28/12/2025',
          durata:'Senza vincoli',
          noCommitment:true,
          note:'Prezzo promozionale per 12 mesi. Nessun vincolo di permanenza.'
        },
        { id:'WIFI_OF', name:'Sky WiFi Open Fiber (Senza vincoli)',
          match:()=>true,
          price:'22,90‚Ç¨', priceValue:22.90,
          attivazione:'29‚Ç¨',
          codiceVoce:{consumo:'1400936', unlimited:'1400937'},
          scadenza:'28/12/2025',
          durata:'Senza vincoli',
          noCommitment:true,
          note:'Disponibile solo su copertura Open Fiber. Nessun vincolo.'
        }
      ],
  
      /* ---- WiFi Business ---- */
      businessWifi:[
        { id:'BIZ_WIFI_BB', name:'Sky WiFi BB Business',
          match:()=>true,
          price:'29,89‚Ç¨ (24,50‚Ç¨ + IVA)',
          priceValue:29.89,
          attivazione:'35,38‚Ç¨ (29‚Ç¨ + IVA)',
          codiceVoce:{consumo:'1401041', unlimited:'1401056'},
          scadenza:'31/12/2025',
          durata:'12 mesi',
          note:'Offerta business Sky WiFi BB: canone 24,50‚Ç¨ + IVA per 12 mesi.'
        }
      ]
    };
  
    /* === Stato === */
    const state = {
      tipo:null,
      off:null,
      voce:null,
      tv:new Set(),
      nf:'none',
      glassEnabled:false,
      glassSize:'43',
      glassPlan:'unico'
    };
  
    let lastBest = null;
  
    /* === UI === */
    const syncBlocks = ()=>{
      const off = state.off;
      qs('#voiceBlock').style.display = (off==='wifi' || off==='wifi_tv' || off==='wifi_tv_glass') ? 'block' : 'none';
      qs('#tvBlock').style.display    = (off==='only_tv' || off==='wifi_tv' || off==='wifi_tv_glass') ? 'block' : 'none';
  
      // 4P: Netflix base obbligatorio
      if (off === 'wifi_tv_glass'){
        const nfChips = qsa('#chipsNF .chip');
        nfChips.forEach(b => b.setAttribute('aria-pressed','false'));
        const baseChip = nfChips.find(b => b.dataset.value === 'base');
        if (baseChip) baseChip.setAttribute('aria-pressed','true');
        state.nf = 'base';
      }
    };
  
    /* Limita le offerte per cliente Business: solo WiFi */
    const adjustOfferOptions = ()=>{
      const offSel = qs('#offerta');
      if (!offSel) return;
      const opts   = Array.from(offSel.options || []);
  
      if (state.tipo === 'business'){
        opts.forEach(opt=>{
          if (!opt.value) return;
          opt.hidden = (opt.value !== 'wifi');
        });
        offSel.value = 'wifi';
        state.off    = 'wifi';
        syncBlocks();
      } else {
        opts.forEach(opt=>{
          if (!opt.value) return;
          opt.hidden = false;
        });
        offSel.value = '';
        state.off    = null;
        syncBlocks();
      }
    };
  
    const scrollToResult = () => qs('#result').scrollIntoView({behavior:'smooth',block:'start'});
  
    const promoCard = qs('#promoCard');
    const promoBtn  = qs('#promoBtn');
    if (promoBtn && promoCard) {
      promoBtn.addEventListener('click', () => {
        const show = promoCard.style.display !== 'block';
        promoCard.style.display = show ? 'block' : 'none';
        if (show) promoCard.scrollIntoView({ behavior:'smooth', block:'start' });
      });
    }
  
    qs('#tipoCliente').addEventListener('change', e=>{
      state.tipo = e.target.value;
      adjustOfferOptions();
    });
  
    qs('#offerta').addEventListener('change', e=>{
      state.off = e.target.value;
      syncBlocks();
    });
  
    /* === Selezione chip === */
    document.addEventListener('click', e=>{
      const btn = e.target.closest('.chip'); if(!btn) return;
      const group = btn.dataset.group, rawValue = btn.dataset.value;
  
      if(group==='voce'){
        qsa('#chipsVoce .chip').forEach(b=>b.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
        state.voce = rawValue;
  
      }else if(group==='nf'){
        let value = rawValue;
        // 4P: non si pu√≤ togliere Netflix
        if (state.off === 'wifi_tv_glass' && value === 'none'){
          value = 'base';
        }
        qsa('#chipsNF .chip').forEach(b=>{
          b.setAttribute('aria-pressed', b.dataset.value === value ? 'true' : 'false');
        });
        state.nf = value;
  
      }else if(group==='tv'){
        const pressed = btn.getAttribute('aria-pressed')==='true';
        btn.setAttribute('aria-pressed', String(!pressed));
        if(pressed) state.tv.delete(rawValue); else state.tv.add(rawValue);
  
      }else if(group==='glass_size'){
        qsa('#chipsGlassSize .chip').forEach(b=>b.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
        state.glassSize = rawValue;
        if(lastBest && state.glassEnabled) updateGlassDetails(lastBest);
  
      }else if(group==='glass_plan'){
        qsa('#chipsGlassPlan .chip').forEach(b=>b.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
        state.glassPlan = rawValue;
        if(lastBest && state.glassEnabled) updateGlassDetails(lastBest);
      }
    });
  
    /* === FUNZIONI DI CALCOLO === */
  
    /* Extra per 3P (packs + Netflix), con pacchetti inclusi in promo */
    const THREEP_PACK_UPCHARGE = { calcio:8.00, sport:22.90, cinema:10.00, kids:5.00, uhd:5.00 };
    function computeExtra3P(base, sel, nf){
      const included = new Set(base.included||[]);
      let extra=0;
      const addedPacks=[];
      const extraPackIds=[];
      const includedSelected=[];
  
      ['calcio','sport','cinema','kids','uhd'].forEach(p=>{
        if(sel.has(p)){
          if(included.has(p)){
            includedSelected.push(p);
          }else{
            const add = THREEP_PACK_UPCHARGE[p]||0;
            if(add>0){
              extra+=add;
              const label = PACK_LABEL[p] || (p[0].toUpperCase()+p.slice(1));
              addedPacks.push(`${label} ${add.toFixed(2)}‚Ç¨`);
              extraPackIds.push(p);
            }
          }
        }
      });
  
      if(nf && nf!=='none'){
        const delta = NF_MONTHLY[nf]||0;
        if(delta>0){
          extra+=delta;
          addedPacks.push(`Netflix ${nfLabel(nf)} +${delta.toFixed(2)}‚Ç¨`);
        }
      }
  
      return {
        extra:Number(extra.toFixed(2)),
        breakdown:addedPacks,
        includedSelected,
        extraPackIds
      };
    }
  
    /* Listino standard Only TV: Sky TV + (eventuale) Netflix + pacchetti */
    function composeTVListino(sel,nf){
      let subtotal = 0;
      const breakdown = [];
  
      const baseTV = LISTINO.base.sky_tv;
  
      if (nf && nf !== 'none'){
        const delta = NF_MONTHLY[nf] || 0;
        subtotal = baseTV + delta;
        breakdown.push(`Sky TV + Netflix ${nfLabel(nf)} ${subtotal.toFixed(2)}‚Ç¨`);
      } else {
        subtotal = baseTV;
        breakdown.push(`Sky TV ${baseTV.toFixed(2)}‚Ç¨`);
      }
  
      const P = LISTINO.base.pacchetti;
      ['sport','cinema','calcio','kids','uhd'].forEach(p=>{
        if(sel.has(p)){
          const add=P[p]||0;
          if(add>0){
            subtotal+=add;
            const label=PACK_LABEL[p] || (p[0].toUpperCase()+p.slice(1));
            breakdown.push(`${label} ${add.toFixed(2)}‚Ç¨`);
          }
        }
      });
  
      return { subtotal:Number(subtotal.toFixed(2)), breakdown, title: breakdown[0].replace(/\s[\d.]+‚Ç¨$/,'') };
    }
  
    /* === ANALISI 18 MESI (FIX definitivo: extra sempre incluso, anche su promo senza phases) === */
    function compute18M(promo, extraMonthly=0){
      const months = 18;
      const extra = (Number(extraMonthly) || 0);
  
      if (promo.phases && promo.phases.length){
        let total = 0;
        let m = 0;
        promo.phases.forEach(ph=>{
          const mm = Number(ph.months) || 0;
          const pr = Number(ph.price)  || 0;
          total += pr * mm;
          m     += mm;
        });
        const effectiveMonths = (m > 0 ? m : months);
        total += extra * effectiveMonths;
        const avg = total / effectiveMonths;
        return { total:Number(total.toFixed(2)), avg:Number(avg.toFixed(2)), months:effectiveMonths };
      }
  
      const base = (Number(promo.priceValue) || 0);
      const totalMonthly = base + extra;
      const total = totalMonthly * months;
      const avg = total / months;
      return { total:Number(total.toFixed(2)), avg:Number(avg.toFixed(2)), months };
    }
  
    /* Candidate per Only TV: promo + extra pacchetti/Netflix (ottimizzate su 18 mesi) */
    function buildTvOnlyCandidates(sel,nf){
      const candidates=[];
      const P = LISTINO.base.pacchetti;
  
      PROMO.tvOnly.forEach(p=>{
        if(!p.match(sel,nf)) return;
  
        const includedSet = new Set(p.included||[]);
        const includedSelected=[];
        const breakdown=[];
        const extraPackIds=[];
        let extra=0;
  
        ['sport','cinema','calcio','kids','uhd'].forEach(pk=>{
          if(sel.has(pk)){
            if(includedSet.has(pk)){
              includedSelected.push(pk);
            }else{
              const add = P[pk] || 0;
              if(add>0){
                extra+=add;
                const label = PACK_LABEL[pk] || (pk[0].toUpperCase()+pk.slice(1));
                breakdown.push(`${label} ${add.toFixed(2)}‚Ç¨`);
                extraPackIds.push(pk);
              }
            }
          }
        });
  
        // Netflix: se la promo include Netflix base, gli upgrade sono differenziali
        if(nf && nf !== 'none'){
          if (p.includesNetflixBase){
            const base = NF_MONTHLY.base || 0;
            const wanted = NF_MONTHLY[nf] || 0;
            const delta = Math.max(0, wanted - base);
            if (delta > 0){
              extra += delta;
              breakdown.push(`Upgrade Netflix ${nfLabel(nf)} +${delta.toFixed(2)}‚Ç¨`);
            }
          } else {
            const delta = NF_MONTHLY[nf] || 0;
            if (delta > 0){
              extra += delta;
              breakdown.push(`Netflix ${nfLabel(nf)} +${delta.toFixed(2)}‚Ç¨`);
            }
          }
        }
  
        const totalMonthly = Number((p.priceValue + extra).toFixed(2));
        const m18 = compute18M(p, extra);
  
        candidates.push({
          base:p,
          totalMonthly,
          total18:m18.total,
          avg18:m18.avg,
          months18:m18.months,
          breakdown,
          includedSelected,
          extraPackIds,
          extra:Number(extra.toFixed(2))
        });
      });
  
      return candidates;
    }
  
    /* Candidate per 3P (usate sia per 3P che per 4P Glass) */
    function buildThreePCandidates(sel,nf){
      const promos = PROMO.threeP;
      const candidates = [];
  
      const base   = promos.find(p=>p.id==='3P_BASE');
      const sport  = promos.find(p=>p.id==='3P_SPORT');
      const cinema = promos.find(p=>p.id==='3P_CINEMA');
  
      const list = [];
      if(base)   list.push(base);
      if(sport && sel.has('sport'))   list.push(sport);
      if(cinema && sel.has('cinema')) list.push(cinema);
  
      list.forEach(p=>{
        const {extra,breakdown,includedSelected,extraPackIds} = computeExtra3P(p, sel, nf);
        const total = Number((p.priceValue + extra).toFixed(2));
        candidates.push({ base:p, total, breakdown, includedSelected, extraPackIds });
      });
  
      return candidates;
    }
  
    /* === RECESSO (valori di esempio) === */
    const COSTI_RECESSO = {
      tv:  [10.10,20.20,30.30,40.40,50.50,50.50,50.50,50.50,50.50,50.50,50.50,50.50,50.50,40.40,30.30,20.20,10.10,0.00],
      tv1: [14.10,28.20,42.30,56.40,70.50,70.50,70.50,70.50,70.50,70.50,70.50,70.50,70.50,56.40,42.30,28.20,14.10,0.00],
      tv2: [18.10,36.20,54.30,72.40,90.50,90.50,90.50,90.50,90.50,90.50,90.50,90.50,90.50,72.40,54.30,36.20,18.10,0.00],
      tv3: [22.10,44.20,66.30,88.40,110.50,110.50,110.50,110.50,110.50,110.50,110.50,110.50,110.50,88.40,66.30,44.20,22.10,0.00],
    };
  
    function getRecessoImporto(mese, config){
      const arr = COSTI_RECESSO[config];
      if (!arr) return null;
      const idx = mese - 1;
      if (idx < 0 || idx >= arr.length) return null;
      return arr[idx];
    }
  
    function labelConfig(config){
      switch(config){
        case 'tv':  return 'Sky TV';
        case 'tv1': return 'Sky TV + 1 pack';
        case 'tv2': return 'Sky TV + 2 pack';
        case 'tv3': return 'Sky TV + 3 pack';
        default:    return config;
      }
    }
  
    /* === SKY GLASS HELPERS === */
    function getGlassConfig(){
      const size = state.glassSize || '43';
      const plan = state.glassPlan || 'unico';
      const sizeCfg = GLASS[size] || GLASS['43'];
      return sizeCfg[plan] || sizeCfg.unico;
    }
  
    function updateGlassDetails(best){
      const glassBox   = qs('#glassBox');
      const glassNote  = qs('#glassNote');
      const glassKpi   = qs('#glassKpi');
      const glassKpiTx = qs('#glassKpiText');
      const compDevice = qs('#compDevice');
      const promoEl    = qs('#glassPromoMonthly');
      const rateEl     = qs('#glassRateMonthly');
      const totalEl    = qs('#glassTotalMonthly');
  
      if(!best){ return; }
  
      if(!state.glassEnabled){
        if(glassBox) glassBox.style.display = 'none';
        if(glassKpi) glassKpi.style.display = 'none';
        if(compDevice) compDevice.textContent = best.compDevice || '‚Äî';
        if(promoEl) promoEl.textContent = '‚Äî';
        if(rateEl)  rateEl.textContent  = '‚Äî';
        if(totalEl) totalEl.textContent = '‚Äî';
        return;
      }
  
      const cfg      = getGlassConfig();
      const summary  = cfg.summary;
      const promoVal = best.totalMonthly || best.totalValue || best.priceValue || 0;
      const rata     = cfg.monthly || 0;
  
      if(glassBox) glassBox.style.display = 'block';
      if(glassNote) glassNote.textContent = summary;
      if(glassKpi){
        glassKpi.style.display = 'block';
        if(glassKpiTx) glassKpiTx.textContent = summary;
      }
      if(compDevice) compDevice.textContent = summary;
  
      if(promoEl){
        promoEl.textContent = promoVal ? formatEUR(promoVal) : '‚Äî';
      }
      if(rateEl){
        rateEl.textContent = rata ? formatEUR(rata) : '‚Äî (solo pagamento unico)';
      }
      if(totalEl){
        totalEl.textContent = promoVal ? formatEUR(promoVal + rata) : '‚Äî';
      }
    }
  
    function setupGlassVisibility(best){
      const glassCta   = qs('#glassCtaWrapper');
      const toggleBtn  = qs('#toggleGlassBtn');
      const glassBox   = qs('#glassBox');
      const glassKpi   = qs('#glassKpi');
  
      if(!glassCta || !toggleBtn) return;
  
      const canGlass =
        (state.off === 'wifi_tv_glass') ||
        (state.off === 'only_tv' && best && best.hasNetflix);
  
      if(!canGlass){
        state.glassEnabled = false;
        glassCta.style.display = 'none';
        if(glassBox) glassBox.style.display = 'none';
        if(glassKpi) glassKpi.style.display = 'none';
        updateGlassDetails(best);
        return;
      }
  
      glassCta.style.display = 'block';
  
      if(state.off === 'wifi_tv_glass'){
        state.glassEnabled = true;
      }
  
      if(state.glassEnabled){
        toggleBtn.textContent = state.off === 'wifi_tv_glass' ? 'Configura Sky Glass' : 'Rimuovi Sky Glass';
      } else {
        toggleBtn.textContent = 'Aggiungi Sky Glass';
      }
  
      updateGlassDetails(best);
    }
  
    /* === COMPOSIZIONE OFFERTA === */
    function fillComposition(best){
      const off   = state.off;
      const sel   = new Set(state.tv);
      const nfSel = state.nf;
      const voce  = state.voce;
  
      const promoIncluded = new Set(best.included || []);
      const effectivePacks = new Set([...sel, ...promoIncluded]);
  
      let effectiveNf = nfSel || 'none';
      if (best.includesNetflixBase && (effectiveNf === 'none' || !effectiveNf)) effectiveNf = 'base';
  
      let bundle = '';
  
      if (off === 'wifi_tv' || off === 'wifi_tv_glass') {
        const parts = ['Sky TV'];
        if (effectivePacks.has('sport'))  parts.push('Sport');
        if (effectivePacks.has('cinema')) parts.push('Cinema');
        if (effectivePacks.has('calcio')) parts.push('Calcio');
        if (effectivePacks.has('kids'))   parts.push('Kids');
        if (effectivePacks.has('uhd'))    parts.push('UHD/4K');
        parts.push('WiFi');
        bundle = parts.join(' + ');
      } else if (off === 'only_tv') {
        const parts = ['Sky TV'];
        const packs = [];
        if (effectivePacks.has('sport'))  packs.push('Sport');
        if (effectivePacks.has('cinema')) packs.push('Cinema');
        if (effectivePacks.has('calcio')) packs.push('Calcio');
        if (effectivePacks.has('kids'))   packs.push('Kids');
        if (effectivePacks.has('uhd'))    packs.push('UHD/4K');
        if (packs.length) parts.push(packs.join(' + '));
        bundle = parts.join(' + ');
      } else if (off === 'wifi') {
        bundle = 'Sky WiFi';
      } else {
        bundle = best.name || '‚Äî';
      }
  
      const extras = [];
  
      if (effectiveNf && effectiveNf !== 'none'){
        if (best.includesNetflixBase){
          if (nfSel === 'standard' || nfSel === 'premium'){
            extras.push(`Netflix ${nfLabel(effectiveNf)} (upgrade)`);
          } else {
            extras.push(`Netflix ${nfLabel(effectiveNf)} (incluso)`);
          }
        } else {
          extras.push(`Netflix ${nfLabel(effectiveNf)}`);
        }
      }
  
      if (voce === 'unlimited') extras.push('Voce Unlimited');
      else if (voce === 'consumo') extras.push('Voce a consumo');
  
      if (Array.isArray(best.extraPackIds) && best.extraPackIds.length){
        const labels = best.extraPackIds.map(p => PACK_LABEL[p] || (p[0].toUpperCase()+p.slice(1)));
        extras.push(`Pacchetti aggiunti: ${labels.join(', ')}`);
      }
  
      let device = '‚Äî';
      if (off === 'wifi_tv_glass') {
        device = 'Sky Glass (configurabile)';
      } else if (off === 'wifi_tv' || off === 'only_tv') {
        device = 'Decoder / Stream Sky';
      }
  
      const durataStr = best.durata || '';
      const durataMatch = durataStr.match(/(\d+)/);
      const durataMesi = durataMatch ? durataMatch[1] : '';
      const vincolo = best.noCommitment ? 'Senza vincoli' : (durataMesi || '‚Äî');
  
      best.compBundle     = bundle || '‚Äî';
      best.compPacks      = extras.length ? extras.join(' ¬∑ ') : 'Nessuna opzione aggiuntiva';
      best.compDevice     = device;
      best.compActivation = best.attivazione || '-';
      best.compVincolo    = vincolo;
      best.compDurata     = durataMesi || (best.durata || '‚Äî');
    }
  
    /* === CORE: COMPUTE BEST === */
    function computeBest(){
      if(!state.tipo || !state.off) return {error:'Seleziona tipologia cliente e offerta richiesta.'};
      const off=state.off, sel=new Set(state.tv), voce=state.voce, nf=state.nf;
  
      // WiFi Business
      if(state.tipo==='business' && off==='wifi'){
        const ch = PROMO.businessWifi[0];
        const best={...ch,totalMonthly:ch.priceValue,totalValue:ch.priceValue,isPromo:true,includedSelected:[],extraPackIds:[]};
        if(best.codiceVoce){
          const voceKey=state.voce||'consumo';
          best.codice=best.codiceVoce[voceKey];
        }
        best.hasNetflix = false;
        return {best};
      }
  
      // 3P / 4P Glass
      if(off==='wifi_tv' || off==='wifi_tv_glass'){
        if(!voce) return {error:'Seleziona l\'opzione Voce.'};
        const candidates = buildThreePCandidates(sel,nf);
        if(!candidates.length) return {error:'Nessuna combinazione disponibile.'};
        candidates.sort((a,b)=>a.total-b.total);
        const ch=candidates[0];
        const best={...ch.base,totalMonthly:ch.total,totalValue:ch.total,breakdown:ch.breakdown,isPromo:true,includedSelected:ch.includedSelected,extraPackIds:ch.extraPackIds};
        if(best.codiceVoce){
          const voceKey=state.voce||'consumo';
          best.codice=best.codiceVoce[voceKey];
        }
        if(off==='wifi_tv_glass') best.isGlass = true;
        best.hasNetflix = (nf && nf !== 'none');
        return {best};
      }
  
      // Only WiFi privati
      if(off==='wifi'){
        if(!voce) return {error:'Seleziona l\'opzione Voce.'};
        const main=PROMO.wifi.find(x=>x.id==='WIFI_MAIN');
        const of  =PROMO.wifi.find(x=>x.id==='WIFI_OF');
        const voceKey=voce||'consumo';
        const best={...main,totalMonthly:main.priceValue,totalValue:main.priceValue,isPromo:true,codice:main.codiceVoce[voceKey],includedSelected:[],extraPackIds:[]};
        const alt ={...of,  totalMonthly:of.priceValue,  totalValue:of.priceValue,  isPromo:true,codice:of.codiceVoce[voceKey],  includedSelected:[],extraPackIds:[]};
        best.hasNetflix = false;
        return {best,context:'wifi',alt};
      }
  
      // Only TV: promo ottimizzate su costo totale 18 mesi
      if(off==='only_tv'){
        const promoCandidates = buildTvOnlyCandidates(sel,nf);
        let best;
  
        if(promoCandidates.length){
          promoCandidates.sort((a,b)=> (a.total18 - b.total18) || (a.totalMonthly - b.totalMonthly));
          const ch = promoCandidates[0];
  
          best={
            ...ch.base,
            totalMonthly:ch.totalMonthly,
            totalValue:ch.totalMonthly,
            total18:ch.total18,
            avg18:ch.avg18,
            months18:ch.months18,
            breakdown:ch.breakdown,
            includedSelected:ch.includedSelected,
            extraPackIds:ch.extraPackIds,
            extra:ch.extra
          };
        } else {
          const list = composeTVListino(sel,nf);
          best = {
            name: list.title,
            priceValue: list.subtotal,
            totalMonthly: list.subtotal,
            totalValue: list.subtotal,
            total18: Number((list.subtotal * 18).toFixed(2)),
            avg18: list.subtotal,
            attivazione:'Stream 19‚Ç¨',
            codice:'LISTINO_TV',
            scadenza:'Listino Sky Smart in vigore',
            durata:'Senza promo (listino)',
            note: list.breakdown.join(' ¬∑ '),
            isPromo:false,
            includedSelected:[],
            extraPackIds:Array.from(sel),
            includesNetflixBase:false
          };
        }
  
        best.hasNetflix = !!best.includesNetflixBase || (nf && nf !== 'none');
        return {best};
      }
  
      return {error:'Nessuna combinazione disponibile.'};
    }
  
    /* === RENDER === */
    function renderResult(r){
      const noRes = qs('#noResult');
      const res   = qs('#result');
  
      if (r.error){
        noRes.style.display = 'block';
        noRes.textContent   = r.error;
        res.style.display   = 'none';
        return;
      }
  
      noRes.style.display = 'none';
      res.style.display   = 'block';
  
      const best  = r.best;
      const monthly = (best.totalMonthly ?? best.totalValue ?? best.priceValue);
  
      qs('#bestName').textContent    = best.name;
      qs('#priceAmount').textContent = formatEUR(monthly);
      qs('#attivazione').textContent = best.attivazione || '-';
      qs('#codice').textContent      = best.codice || '-';
      qs('#scadenza').textContent    = best.scadenza || '-';
      qs('#note').textContent        = best.note || '-';
      qs('#contractCta').style.display = 'block';
  
      // Dettaglio prezzo SOLO per 1100772
      const priceDetailEl = qs('#priceDetail');
      if (priceDetailEl){
        if (best.id === 'TV_NF_CINEMA_UHD_STEP' && best.priceDetail){
          priceDetailEl.style.display = 'block';
          priceDetailEl.textContent   = best.priceDetail;
        } else {
          priceDetailEl.style.display = 'none';
          priceDetailEl.textContent   = '';
        }
      }
  
      // Badge ‚Äúinclusi‚Äù
      const formulaBox = qs('#formulaBox');
      const inc = new Set(best.included || []);
      const incLabels = [];
      inc.forEach(p=>{
        if (PACK_LABEL[p]) incLabels.push(PACK_LABEL[p]);
      });
      if (best.includesNetflixBase) incLabels.push('Netflix (base) incluso');
  
      if (incLabels.length){
        formulaBox.textContent = `Inclusi in promo: ${incLabels.join(', ')}`;
        formulaBox.style.display = 'inline-block';
      } else {
        formulaBox.style.display = 'none';
      }
  
      // Analisi 18 mesi
      const recap = qs('#recapBox');
      if (typeof best.total18 === 'number' && typeof best.avg18 === 'number'){
        recap.style.display = 'block';
        recap.innerHTML = `
          <h4>Analisi 18 mesi (scelta ottimizzata sul totale)</h4>
          <div class="recap-grid">
            <div class="recap-label">Costo totale (18 mesi)</div>
            <div class="recap-value">${formatEUR(best.total18)}</div>
  
            <div class="recap-label">Canone medio mensile (18 mesi)</div>
            <div class="recap-value">${formatEUR(best.avg18)}</div>
          </div>
          ${(best.id==='TV_NF_CINEMA_UHD_STEP' && best.priceDetail)
            ? `<div class="notes" style="margin-top:8px">Dettaglio canone: ${best.priceDetail}</div>`
            : ``}
        `;
      } else {
        recap.style.display = 'none';
        recap.innerHTML = '';
      }
  
      fillComposition(best);
      const compBox = qs('#compositionBox');
      if (compBox){
        compBox.style.display = 'block';
        qs('#compBundle').textContent     = best.compBundle     || '‚Äî';
        qs('#compPacks').textContent      = best.compPacks      || '‚Äî';
        qs('#compDevice').textContent     = best.compDevice     || '‚Äî';
        qs('#compActivation').textContent = best.compActivation || '‚Äî';
        qs('#compVincolo').textContent    = best.compVincolo    || '‚Äî';
        qs('#compDurata').textContent     = best.compDurata     || '‚Äî';
      }
  
      lastBest = best;
      setupGlassVisibility(best);
  
      scrollToResult();
    }
  
    /* === CALCOLO RECESSO PRIVATI === */
    const calcRecessoBtn = qs('#calcRecesso');
    if (calcRecessoBtn){
      calcRecessoBtn.addEventListener('click', ()=>{
        const meseStr = qs('#mesiTrascorsi').value;
        const conf    = qs('#nPacchetti').value;
  
        if (!meseStr || !conf){
          alert('Seleziona sia il mese che la configurazione TV.');
          return;
        }
  
        const mese    = Number(meseStr);
        const importo = getRecessoImporto(mese, conf);
        const box     = qs('#resRecesso');
  
        if (importo == null){
          qs('#totRecesso').textContent   = '‚Äî';
          qs('#detailRecesso').textContent =
            'Non sono presenti valori per questa combinazione. Completa la costante COSTI_RECESSO nel codice.';
        } else {
          qs('#totRecesso').textContent   = formatEUR(importo);
          qs('#detailRecesso').textContent =
            `Configurazione: ${labelConfig(conf)} ¬∑ Mesi trascorsi: ${mese}. Valore prelevato dalla tabella recesso.`;
        }
  
        box.style.display = 'block';
        box.scrollIntoView({behavior:'smooth', block:'start'});
      });
    }
  
    /* === Eventi === */
    const runCalc=()=>renderResult(computeBest());
    qs('#calcBtn').addEventListener('click',runCalc);
    qs('#calcBtnMb').addEventListener('click',runCalc);
    qs('#resetBtn').addEventListener('click',()=>location.reload());
    qs('#copyCode').addEventListener('click',()=>{
      const code=qs('#codice').textContent.trim();
      if(code&&code!=='-')navigator.clipboard.writeText(code);
    });
  
    const toggleGlassBtn = qs('#toggleGlassBtn');
    if (toggleGlassBtn){
      toggleGlassBtn.addEventListener('click', ()=>{
        if(!lastBest) return;
        if(state.off === 'wifi_tv_glass'){
          state.glassEnabled = true;
        } else {
          state.glassEnabled = !state.glassEnabled;
        }
        setupGlassVisibility(lastBest);
      });
    }
  
  })();
  <!-- ===================== PART 3/3 ===================== -->
  </script>
</body>
</html>


<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Offerte SKY ‚Äì dal 10 Novembre</title>
<style>
  *{box-sizing:border-box}
  html,body{margin:0}

  :root{
    /* Palette chiara ispirata a Sky */
    --bg:#f5f7ff;
    --bg-soft:#ffffff;
    --card:#ffffff;
    --text:#111827;
    --sub:#5b6b8b;

    --muted:#eef2ff;
    --border:#dde3f7;

    --accent:#e6007e;      /* magenta Sky */
    --accent2:#0072ff;     /* blu Sky */
    --accent-soft:#eef3ff;

    --ring:0 0 0 2px rgba(0,114,255,.25);
    --shadow:0 10px 26px rgba(15,23,42,.10);
    --softshadow:0 6px 18px rgba(15,23,42,.08);
    --radius:18px;
  }

  body{
    background:
      radial-gradient(circle at 0% 0%, #f0f4ff 0, transparent 55%),
      radial-gradient(circle at 100% 0%, #ffe4f4 0, transparent 55%),
      linear-gradient(180deg,#f7f9ff,#f5f7ff 55%,#f0f4ff 100%);
    color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    font-size:16px;
    line-height:1.3;
    padding-bottom:88px;
  }

  .wrap{
    max-width:1100px;
    margin:20px auto 40px;
    padding:0 14px;
  }

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:16px;
  }

  .brand{
    display:flex;
    align-items:center;
    gap:12px;
  }

  .logo{
    width:88px;
    height:44px;
    border-radius:16px;
    background:
      linear-gradient(135deg,var(--accent),var(--accent2));
    box-shadow:0 10px 24px rgba(148,163,184,.45);
    position:relative;
  }

  .logo::after{
    content:"sky";
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    font-size:16px;
    color:#fff;
    text-transform:lowercase;
    letter-spacing:.04em;
  }

  h1{
    font-size:20px;
    margin:0;
    font-weight:800;
    letter-spacing:.03em;
    text-transform:uppercase;
    color:#111827;
  }

  header .btn.secondary{
    font-size:13px;
    padding:9px 14px;
    border-radius:999px;
    background:#ffffff;
    color:#1d4ed8;
    border:1px solid #c7d2fe;
    box-shadow:0 2px 8px rgba(15,23,42,.06);
  }
  header .btn.secondary:hover{
    background:#eef2ff;
  }

  /* CARD GENERALI */
  .form-card,
  .result-card,
  details.result-card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px 16px 14px;
  }

  .form-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:10px;
  }

  .form-title{
    display:flex;
    align-items:center;
    gap:8px;
  }

  .step{
    width:26px;
    height:26px;
    display:grid;
    place-items:center;
    border-radius:10px;
    background:radial-gradient(circle at 0% 0%,#ffffff 0,#ffe4f5 40%,#e6007e 100%);
    color:#111827;
    font-weight:900;
    font-size:12px;
    box-shadow:0 8px 18px rgba(148,163,184,.7);
  }

  .form-header .muted{
    font-size:13px;
    color:#6b7280;
  }

  .row{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }

  label{
    display:block;
    font-size:13px;
    color:#374151;
    margin:0 0 6px 2px;
    font-weight:600;
  }

  select{
    width:100%;
    background:#ffffff;
    color:var(--text);
    border:1px solid var(--border);
    padding:11px 14px;
    border-radius:12px;
    outline:none;
    font-size:15px;
    transition:box-shadow .18s ease,border-color .18s ease,background .18s ease,transform .08s ease;
    appearance:none;
    box-shadow:0 0 0 rgba(0,0,0,0);
  }

  select:focus{
    box-shadow:var(--ring);
    border-color:#93c5fd;
    background:#ffffff;
    transform:translateY(-1px);
  }

  select option{
    background:#ffffff;
    color:#111827;
  }

  /* CHIPS griglia responsiva (no overflow) */
  .chips{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
    gap:8px;
    padding:10px;
    background:var(--muted);
    border-radius:14px;
    border:1px solid var(--border);
  }

  .chips .chip{
    appearance:none;
    width:100%;
    text-align:center;
    border:1px solid #c7d2fe;
    padding:9px 10px;
    border-radius:999px;
    font-size:13px;
    background:#ffffff;
    box-shadow:0 4px 10px rgba(148,163,184,.4);
    white-space:normal;
    color:#1f2937;
    font-weight:500;
    cursor:pointer;
    transition:background .16s ease,transform .08s ease,border-color .16s ease,box-shadow .16s ease,color .16s ease;
  }

  .chips .chip:hover{
    border-color:#6366f1;
    box-shadow:0 6px 14px rgba(148,163,184,.55);
    transform:translateY(-1px);
  }

  .chip[aria-pressed="true"]{
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    border-color:transparent;
    color:#ffffff;
    font-weight:700;
    box-shadow:0 8px 18px rgba(129,140,248,.7);
  }

  .btn{
    background:linear-gradient(135deg,var(--accent2),var(--accent));
    color:#fff;
    border:none;
    padding:12px 16px;
    border-radius:999px;
    font-weight:800;
    cursor:pointer;
    box-shadow:0 10px 22px rgba(129,140,248,.6);
    font-size:15px;
    letter-spacing:.03em;
    text-transform:uppercase;
    transition:transform .08s ease,box-shadow .12s ease,filter .12s ease;
  }

  .btn:hover{
    transform:translateY(-1px);
    filter:brightness(1.03);
    box-shadow:0 12px 26px rgba(129,140,248,.7);
  }

  .btn:active{
    transform:translateY(0);
    box-shadow:0 8px 18px rgba(129,140,248,.5);
  }

  .btn.secondary{
    background:#ffffff;
    color:#1d4ed8;
    border:1px solid #c7d2fe;
    box-shadow:0 2px 8px rgba(148,163,184,.35);
    text-transform:none;
    letter-spacing:.01em;
    font-weight:600;
  }

  .btn.secondary:hover{
    background:#eef2ff;
    box-shadow:0 4px 12px rgba(148,163,184,.55);
  }

  .results{
    margin-top:14px;
  }

  .result-head{
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .result-name{
    font-size:19px;
    font-weight:900;
    color:#111827;
  }

  .kpis{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
    margin-top:12px;
  }

  .kpi{
    background:#f3f4ff;
    border:1px solid #d4ddff;
    border-radius:14px;
    padding:10px 12px;
    box-shadow:0 6px 14px rgba(148,163,184,.45);
  }
  .kpi .muted{
    color:#6b7280;
    font-size:13px;
  }
  .kpi b{
    font-size:18px;
    color:#111827;
  }

  .code{
    font-family:ui-monospace,monospace;
    background:#111827;
    border:1px solid #c7d2fe;
    padding:7px 10px;
    border-radius:10px;
    color:#e5ebff;
    font-size:13px;
  }

  .priceCard{
    background:radial-gradient(circle at 0 0,#e0e7ff 0,#ffffff 55%,#e5e7eb 100%);
    border:1px solid #c7d2fe;
    border-radius:16px;
    padding:12px 14px;
    display:flex;
    flex-direction:column;
    align-items:center;
    box-shadow:0 12px 26px rgba(148,163,184,.7);
    min-width:190px;
  }

  .priceValue{
    font-size:34px;
    line-height:1;
    font-weight:900;
    color:#111827;
  }

  .priceLabel{
    font-size:11px;
    color:#4b5563;
    letter-spacing:.16em;
    text-transform:uppercase;
    margin-top:4px;
  }

  .priceDetail{
    margin-top:8px;
    font-size:13px;
    color:#374151;
    text-align:center;
  }

  .badge{
    display:inline-block;
    padding:4px 9px;
    border-radius:999px;
    background:#e0f2fe;
    border:1px solid #bfdbfe;
    color:#1d4ed8;
    font-size:11px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.08em;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid #fed7aa;
    background:#fffbeb;
    color:#9a3412;
    font-size:11px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.08em;
  }

  .pill.glass{
    border-color:#bfdbfe;
    background:#eff6ff;
    color:#1d4ed8;
  }

  .notes{
    margin-top:10px;
    padding-top:10px;
    border-top:1px dashed #d1d5db;
    color:#4b5563;
    font-size:13px;
  }

  .recap{
    margin-top:10px;
    border:1px dashed #cbd5f5;
    background:#eef2ff;
    border-radius:14px;
    padding:12px 12px 10px;
  }

  .recap h4{
    margin:0 0 8px;
    font-size:14px;
    color:#111827;
    font-weight:700;
  }

  .recap-grid{
    display:grid;
    grid-template-columns:1fr auto;
    row-gap:8px;
    column-gap:10px;
    align-items:center;
  }

  .recap-label{
    color:#4b5563;
    font-size:12px;
  }

  .recap-value{
    font-weight:700;
    font-size:13px;
    color:#111827;
  }

  .recap-badges{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:10px;
  }

  .altContainer{
    margin-top:14px;
  }

  .offerAlt{
    background:#f9fafb;
    border:1px solid #d1d5db;
    border-radius:18px;
    padding:14px 16px;
    display:flex;
    flex-direction:column;
    gap:10px;
    box-shadow:0 10px 22px rgba(148,163,184,.6);
  }

  .offerAlt .head{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:12px;
  }

  .offerAlt .title{
    font-weight:800;
    font-size:15px;
    color:#111827;
  }

  .offerAlt .price{
    font-size:26px;
    font-weight:900;
    letter-spacing:.04em;
    color:#111827;
  }

  .offerAlt .meta{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    color:#4b5563;
    font-size:11px;
  }

  .offerAlt .meta span{
    background:#e5e7eb;
    border:1px solid #d1d5db;
    border-radius:999px;
    padding:5px 9px;
  }

  .offerAlt .notes{
    border-top:1px dashed #d1d5db;
    padding-top:8px;
    margin-top:2px;
    font-size:12px;
    color:#374151;
  }

  .mobileBar{
    position:fixed;
    left:0;
    right:0;
    bottom:0;
    z-index:30;
    background:linear-gradient(180deg,#ffffff,#e5e7eb);
    backdrop-filter:blur(10px);
    border-top:1px solid #d1d5db;
    box-shadow:0 -8px 20px rgba(148,163,184,.7);
    padding:10px 12px 12px;
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
  }
  .mobileBar .btn,
  .mobileBar .btn.secondary{
    width:100%;
  }

  /* Desktop-only elementi nascosti su mobile se usi questa classe */
  .desktopOnly{display:none;}

  @media(min-width:760px){
    h1{font-size:22px;}
    .wrap{padding:0 18px;}
    .row{grid-template-columns:1fr 1fr;}
    .result-head{
      flex-direction:row;
      justify-content:space-between;
      align-items:flex-start;
    }
    .kpis{grid-template-columns:repeat(3,1fr);}
    .priceValue{font-size:40px;}
    body{padding-bottom:0;}
    .mobileBar{display:none;}
    .desktopOnly{display:inline-flex;}
  }
  /* --- CTA INSERISCI CONTRATTO: card separata e pi√π ‚Äúimportante‚Äù --- */
#contractCta{
  margin-top: 28px;
  padding: 18px 20px 22px;
  border-radius: 28px;
  border: 1px solid rgba(191, 204, 255, 0.9);
  background: radial-gradient(circle at 0 0,
              rgba(227,28,121,0.06),
              rgba(12,100,197,0.03) 45%,
              #ffffff 75%);
  box-shadow: 0 18px 40px rgba(15,23,42,0.12);
}

/* bottone dentro alla card CTA */
#contractCta .btn{
  max-width: 420px;
  margin: 0 auto;
  display: block;
  font-size: 15px;
  letter-spacing: .04em;
  text-transform: uppercase;
  padding: 14px 24px;
}

/* pi√π spazio prima del blocco ‚ÄúCalcolo costi di recesso‚Äù */
details.result-card{
  margin-top: 28px !important;
}
/* --- TESTO "TOCCA PER APRIRE" IN BIANCO --- */
details.result-card > summary .muted {
  color: #ffffff !important;
}

/* --- CARD "TOTALE RECESSO" PI√ô GRANDE (circa x2) --- */
#resRecesso{
  padding: 28px 24px;          /* pi√π spazio interno */
}

#resRecesso .result-head{
  align-items: center;
}

#resRecesso .result-name{
  font-size: 24px;             /* titolo pi√π grande */
}

#resRecesso .kpi b{
  font-size: 32px;             /* importo pi√π grande */
}
.promo-card{
  background:linear-gradient(135deg, rgba(77,137,255,0.06), rgba(227,28,121,0.03));
  border-style:dashed;
}
/* Nasconde il pulsante Dataset ovunque */
#listinoBtn,
#listinoBtnMb{
  display:none !important;
}

</style>

</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div><h1>PROMO IN CORSO</h1></div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn secondary" id="promoBtn" type="button">
          üëÅÔ∏è PROMO
        </button>
        <button class="btn secondary" id="resetBtn" aria-label="Pulisci campi" type="button">
          RESET
        </button>
      </div>
    </header>
    <section class="result-card promo-card" id="promoCard" style="display:none; margin-bottom:14px;">
      <div style="font-size:14px; line-height:1.45;">
        <p><strong>üõú Triple Play con Cinema o Sport e UHD 35,80‚Ç¨</strong><br>
        <em>Validit√†: 10 novembre - 1 dicembre (2 giorni di backlog)</em></p>
    
        <p>Restano inoltre attivabili le offerte TV only:</p>
        <ul style="margin:4px 0 8px 18px; padding:0;">
          <li>üì∫ Offerta speciale Sky TV &amp; Netflix 14,99‚Ç¨</li>
          <li>üì∫ Offerta speciale Sky TV + Sport + UHD 24,99‚Ç¨</li>
          <li>üì∫ Offerta speciale Sky TV &amp; Netflix + Cinema 19,99‚Ç¨</li>
        </ul>
    
        <p>Attivabili fino al <strong>01/12</strong> (no backlog).</p>
    
        <p>Le offerte comprendono:</p>
        <ul style="margin:4px 0 8px 18px; padding:0;">
          <li>üëâ <strong>Sky Stream</strong>: decoder facile, veloce e sempre con te.</li>
          <li>üëâ <strong>Sky Go</strong>: i contenuti che i tuoi clienti amano, disponibili subito.</li>
          <li>üëâ <strong>Paramount+</strong>: incluso con Sky Cinema.</li>
        </ul>
    
        <p style="margin-top:4px;">
          √à sempre possibile aggiungere i pacchetti mancanti al prezzo del listino scontato Sky Smart.
        </p>
      </div>
    </section>
    
    
    <!-- ===== FORM ===== -->
    <section class="form-card" id="formCard" aria-labelledby="formTitle">
      <div class="form-header">
        <div class="form-title"><span class="step">1</span><b id="formTitle">Dati di richiesta</b></div>
        <div class="muted" style="font-size:13px;color:#5b6b8b">Compila i campi e premi <b>Calcola offerta</b>.</div>
      </div>

      <div class="row">
        <div>
          <label for="tipoCliente">Tipologia cliente</label>
          <select id="tipoCliente">
            <option value="" selected disabled>Seleziona‚Ä¶</option>
            <option value="privato">Privato</option>
            <option value="business">Business</option>
          </select>
        </div>
        <div>
          <label for="offerta">Offerta richiesta</label>
          <select id="offerta">
            <option value="" selected disabled>Seleziona‚Ä¶</option>
            <option value="only_tv">Only TV</option>
            <option value="wifi">Sky Wifi</option>
            <option value="upsell_wifi">Upsell Wifi (gi√† cliente TV)</option>
            <option value="wifi_tv">Sky Wifi + TV (3P)</option>
            <option value="wifi_tv_glass">Sky wifi + Tv con GLASS (4P)</option>
          </select>
        </div>
      </div>

      <div id="voiceBlock" style="display:none; margin-top:10px;">
        <label>Opzione Voce (solo per Sky Wifi o 3P)</label>
        <div class="chips" id="chipsVoce" aria-label="Seleziona opzione voce">
          <button class="chip" data-group="voce" data-value="consumo" aria-pressed="false">Voce a consumo</button>
          <button class="chip" data-group="voce" data-value="unlimited" aria-pressed="false">Voce Unlimited</button>
        </div>
      </div>

      <div id="tvBlock" style="display:none; margin-top:10px;">
        <div class="row">
          <div>
            <label>Pacchetti TV</label>
            <div class="chips" id="chipsTV" aria-label="Seleziona pacchetti TV">
              <button class="chip" data-group="tv" data-value="calcio" aria-pressed="false">Calcio</button>
              <button class="chip" data-group="tv" data-value="sport"  aria-pressed="false">Sport</button>
              <button class="chip" data-group="tv" data-value="cinema" aria-pressed="false">Cinema</button>
              <button class="chip" data-group="tv" data-value="kids"   aria-pressed="false">Kids</button>
              <button class="chip" data-group="tv" data-value="uhd"    aria-pressed="false">UHD/4K</button>
            </div>
          </div>
          <div>
            <label>Netflix</label>
            <div class="chips" id="chipsNF" aria-label="Seleziona Netflix">
              <button class="chip" data-group="nf" data-value="none"     aria-pressed="true">Nessuno</button>
              <button class="chip" data-group="nf" data-value="base"     aria-pressed="false" title="2 schermi in HD">Standard con</button>
              <button class="chip" data-group="nf" data-value="standard" aria-pressed="false" title="2 schermi in HD">Standard</button>
              <button class="chip" data-group="nf" data-value="premium"  aria-pressed="false" title="4 schermi in 4K">Premium</button>
            </div>
            <div style="margin-top:6px;font-size:12px;color:#55637f">
              Netflix: <b>Standard con pubblicit√†</b> = 2 schermi in HD ¬∑ <b>Standard</b> = 2 schermi in HD ¬∑ <b>Premium</b> = 4 schermi in 4K.
            </div>
          </div>
        </div>
        <div class="muted" style="margin-top:6px;font-size:13px;color:#55637f">Seleziona i pacchetti desiderati. Le promo TV/3P vengono proposte automaticamente.</div>
      </div>

      <!-- Desktop buttons (su mobile si usa la sticky bar) -->
      <div class="row" style="margin-top:10px">
        <div></div>
        <div style="text-align:right;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn desktopOnly" id="calcBtn">Calcola offerta</button>
        </div>
      </div>
    </section>
    <!-- ===== RESULTS ===== -->
    <section class="results" id="results">
      <div class="result-card" id="noResult">Nessun risultato ancora. Compila i campi sopra e premi <b>Calcola offerta</b>.</div>

      <div class="result-card" id="result" style="display:none">
        <div class="result-head">
          <div>
            <div class="muted" style="font-size:13px;color:#5b6b8b">Promo consigliata</div>
            <div class="result-name" id="bestName">-</div>
            <div id="formulaBox" class="badge" style="display:none;margin-top:8px"></div>
          </div>
          <div>
            <div class="priceCard">
              <div class="priceValue" id="priceAmount">‚Äî</div>
              <div class="priceLabel">CANONE MENSILE</div>
            </div>
            <div id="priceDetail" class="priceDetail"></div>
          </div>
        </div>

        <div id="recapBox" class="recap" style="display:none"></div>

        <div class="kpis">
          <div class="kpi">
            <div class="muted">Costo di attivazione</div>
            <b id="attivazione">-</b>
          </div>
          <div class="kpi">
            <div class="muted">Codice attivazione</div>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
              <span class="code" id="codice">-</span>
              <button class="btn secondary" id="copyCode">Copia</button>
            </div>
          </div>
          <div class="kpi" id="glassKpi" style="display:none">
            <div class="muted">Dispositivo incluso</div>
            <b>SKY GLASS 43" Nero ¬∑ 199‚Ç¨ una tantum</b>
          </div>
          <div class="kpi">
            <div class="muted">Scadenza promo</div>
            <b id="scadenza">-</b>
          </div>
        </div>
        <div class="notes" id="note"></div>

        <!-- Alternativa WiFi (Open Fiber come card) -->
        <div id="wifiAlternatives" class="altContainer" style="display:none"></div>
      </div>

      <div class="result-card" id="contractCta" style="display:none">
        <a class="btn" href="http://myspace.e2kdistribution.com/" target="_blank" rel="noopener" style="width:100%">INSERISCI CONTRATTO</a>
      </div>
    </section>

    <!-- ===== STICKY MOBILE BAR ===== -->
    <div class="mobileBar" aria-hidden="false">
      <button class="btn secondary" id="listinoBtnMb">Dataset</button>
      <button class="btn" id="calcBtnMb">Calcola offerta</button>
    </div>

    <!-- ===== RECESSO + DATASET ===== -->
    <details class="result-card" style="margin-top:12px">
      <summary class="btn" style="list-style:none;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
        Calcolo costi di recesso (Privato) <span class="muted" style="font-size:13px;color:#5b6b8b">tocca per aprire</span>
      </summary>
      <div style="padding-top:10px">
        <div class="row">
          <div>
            <label>Mesi trascorsi dall'attivazione</label>
            <select id="mesiTrascorsi">
              <option value="" selected disabled>Seleziona mese‚Ä¶</option>
              <option value="1">1¬∞</option><option value="2">2¬∞</option><option value="3">3¬∞</option>
              <option value="4">4¬∞</option><option value="5">5¬∞</option><option value="6">6¬∞</option>
              <option value="7">7¬∞</option><option value="8">8¬∞</option><option value="9">9¬∞</option>
              <option value="10">10¬∞</option><option value="11">11¬∞</option><option value="12">12¬∞</option>
              <option value="13">13¬∞</option><option value="14">14¬∞</option><option value="15">15¬∞</option>
              <option value="16">16¬∞</option><option value="17">17¬∞</option><option value="18">18¬∞</option>
            </select>
          </div>
          <div>
            <label>Numero pacchetti TV attivi</label>
            <select id="nPacchetti">
              <option value="" selected disabled>Seleziona configurazione‚Ä¶</option>
              <option value="tv">Sky TV</option>
              <option value="tv1">Sky TV + 1 pack</option>
              <option value="tv2">Sky TV + 2 pack</option>
              <option value="tv3">Sky TV + 3 pack</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="muted" style="color:#5b6b8b">I valori corrispondono al grafico ufficiale. Seleziona mese e configurazione, poi calcola.</div>
          <div style="text-align:right"><button class="btn" id="calcRecesso">Calcola recesso</button></div>
        </div>
        <div class="result-card" id="resRecesso" style="display:none;margin-top:10px">
          <div class="result-head">
            <div class="result-name">Totale recesso</div>
            <div class="kpi"><b id="totRecesso">‚Ç¨ 0,00</b></div>
          </div>
          <div class="notes" id="detailRecesso"></div>
        </div>
      </div>
    </details>

    <dialog id="datasetDlg" style="border:none;border-radius:16px;max-width:920px;width:92%;background:#ffffff;color:#111827;">
      <div style="padding:14px 14px 8px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)">
        <b>Dataset promo (interno) ¬∑ v4.3</b>
        <button class="btn secondary" onclick="this.closest('dialog').close()">Chiudi</button>
      </div>
      <div style="padding:12px 14px 18px;max-height:60vh;overflow:auto">
        <pre id="datasetPre" style="white-space:pre-wrap;font-size:12px;line-height:1.35;background:#fafcff;border:1px solid var(--border);padding:12px;border-radius:12px"></pre>
        <div class="muted" style="margin-top:8px;font-size:12px;color:#5b6b8b">Nota: etichette Netflix aggiornate (Standard con pubblicit√†, Standard, Premium).</div>
      </div>
    </dialog>
  </div>

<script>
(function(){
  const qs = s => document.querySelector(s)
  const qsa = s => Array.from(document.querySelectorAll(s))
  const formatEUR = n => new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(n)

  /* Netflix labels */
  const NF_LABEL = { base:'Standard con pubblicit√†', standard:'Standard', premium:'Premium' }
  const NF_NOTE  = { base:'2 schermi in HD',         standard:'2 schermi in HD', premium:'4 schermi in 4K' }
  const nfLabel  = k => NF_LABEL[k] || k

  /* Listino base (usato per TV-only e per i pack extra nelle 3P) */
  const LISTINO = {
    base:{
      sky_tv:14.90,
      netflix:{ base:14.90, standard:21.90, premium:27.90 },
      pacchetti:{ cinema:10.00, sport:22.90, calcio:8.00, kids:5.00, uhd:5.00 }
    }
  }

  /* Tariffa speciale per Netflix quando la base √® una PROMO 3P:
     i valori sono "in pi√π al mese" sul bundle promo, indipendenti dal listino. */
  const THREEP_NF_UPCHARGE = { base:4.99, standard:11.99, premium:17.99 };

  /* PROMO aggiornate (WiFi 25,90 main, OF 22,90 alt; 3P Calcio con codici voce 1300216/1300217) */
  const PROMO = {
    tvOnly:[
      { id:'BF_TV_NF', name:'BLACK FRIDAY ¬∑ Sky TV + Netflix (Standard con pubblicit√†)',
        match:(_,nf)=> nf==='base' || nf==='none',
        price:'14,99‚Ç¨', priceValue:14.99, included:[], includedNetflix:'base',
        attivazione:'Stream 19‚Ç¨', codice:'1100731', scadenza:'01/12/2025', durata:'18 mesi',
        note:'Compatibile con SKY GLASS 43" Nero a 199‚Ç¨ una tantum.'
      },
      { id:'BF_TV_SPORT_UHD', name:'BLACK FRIDAY ¬∑ Sky TV + Sport + UHD',
        match:(s)=> s.has('sport'),
        price:'24,99‚Ç¨', priceValue:24.99, included:['sport','uhd'],
        attivazione:'Stream 19‚Ç¨', codice:'1100741', scadenza:'01/12/2025', durata:'18 mesi',
        note:'Compatibile con SKY GLASS 43" Nero a 199‚Ç¨ una tantum.'
      },
      { id:'BF_TV_NF_CIN', name:'BLACK FRIDAY ¬∑ Sky TV + Netflix (Standard con pubblicit√†) + Cinema',
        match:(s,nf)=> s.has('cinema') && (nf==='base' || nf==='none'),
        price:'19,99‚Ç¨', priceValue:19.99, included:['cinema'], includedNetflix:'base',
        attivazione:'Stream 19‚Ç¨', codice:'1100732', scadenza:'01/12/2025', durata:'18 mesi',
        note:'Compatibile con SKY GLASS 43" Nero a 199‚Ç¨ una tantum.'
      }
    ],

    /* 3P ‚Äì senza promo Calcio 29,90 (scaduta) */
    threeP:[
      { id:'3P_CIN', name:'3P + CINEMA (TV+UHD+WiFi+Cinema)', match:(s)=> s.has('cinema'),
        price:'35,80‚Ç¨', priceValue:35.80, included:['cinema','uhd'],
        attivazione:'Stream 19‚Ç¨ ‚Äì WiFi Gratis', codiceVoce:{consumo:'1300199',unlimited:'1300200'},
        scadenza:'01/12/2025 (+2gg backlog)', durata:'18 mesi',
        note:'Aggiunte: Kids 5‚Ç¨, Sport 22,90‚Ç¨, Netflix opzionale.'
      },
      { id:'3P_SPORT', name:'3P + SPORT (TV+UHD+WiFi+Sport)', match:(s)=> s.has('sport'),
        price:'35,80‚Ç¨', priceValue:35.80, included:['sport','uhd'],
        attivazione:'Stream 19‚Ç¨ ‚Äì WiFi Gratis', codiceVoce:{consumo:'1300205',unlimited:'1300206'},
        scadenza:'01/12/2025 (+2gg backlog)', durata:'18 mesi',
        note:'Aggiunte: Kids 5‚Ç¨, Cinema 10‚Ç¨, Netflix opzionale.'
      },
      { id:'3P_BASE', name:'3P base (TV+WiFi, no pack)', match:(s)=> !s.has('sport') && !s.has('cinema') && !s.has('calcio'),
        price:'29,90‚Ç¨', priceValue:29.90, included:[],
        attivazione:'Stream 19‚Ç¨ ‚Äì WiFi Gratis', codiceVoce:{consumo:'1300208',unlimited:'1300207'},
        scadenza:'01/12/2025 (No backlog)', durata:'18 mesi',
        note:'Pacchetti aggiuntivi a listino; Netflix opzionale.'
      }
    ],

    glassThreeP:[
      { id:'GLASS_CINEMA', name:'3P GLASS: TV + Cinema + 4K + Netflix Base',
        match:(s)=> s.has('cinema'),
        price:'40,89‚Ç¨', priceValue:40.89, included:['cinema','uhd'], includedNetflix:'base',
        attivazione:'WiFi Gratis ‚Äì Consegna GLASS gratuita',
        codice:'1300220', scadenza:'10/12/2025', durata:'18 mesi',
        note:'SKY GLASS 43" Nero incluso nel bundle ¬∑ 199‚Ç¨ una tantum.'
      },
      { id:'GLASS_BASE4K', name:'3P GLASS: TV + 4K + Netflix Base',
        match:(s)=> !s.has('sport') && !s.has('cinema'),
        price:'34,89‚Ç¨', priceValue:34.89, included:['uhd'], includedNetflix:'base',
        attivazione:'WiFi Gratis ‚Äì Consegna GLASS gratuita',
        codice:'1300222', scadenza:'10/12/2025', durata:'18 mesi',
        note:'SKY GLASS 43" Nero incluso nel bundle ¬∑ 199‚Ç¨ una tantum.'
      },
      { id:'GLASS_SPORT', name:'3P GLASS: TV + Sport + 4K + Netflix Base',
        match:(s)=> s.has('sport'),
        price:'40,89‚Ç¨', priceValue:40.89, included:['sport','uhd'], includedNetflix:'base',
        attivazione:'WiFi Gratis ‚Äì Consegna GLASS gratuita',
        codice:'1300221', scadenza:'10/12/2025', durata:'18 mesi',
        note:'SKY GLASS 43" Nero incluso nel bundle ¬∑ 199‚Ç¨ una tantum.'
      }
    ],

    /* WiFi privati ‚Äî principale 25,90; alternativa Open Fiber 22,90 */
    wifi:[
      { id:'WIFI_MAIN', name:'Sky WiFi (Only WiFi ¬∑ Senza vincoli)',
        match:()=>true, price:'25,90‚Ç¨', priceValue:25.90, attivazione:'29‚Ç¨',
        codiceVoce:{consumo:'8122', unlimited:'8123'}, scadenza:'28/12/2025',
        durata:'Senza vincoli', noCommitment:true,
        note:'Prezzo promozionale per 12 mesi. Nessun vincolo di permanenza.'
      },
      { id:'WIFI_OF', name:'Sky WiFi Open Fiber (Senza vincoli)',
        match:()=>true, price:'22,90‚Ç¨', priceValue:22.90, attivazione:'29‚Ç¨',
        codiceVoce:{consumo:'1400936', unlimited:'1400937'}, scadenza:'08/12/2025',
        durata:'Senza vincoli', noCommitment:true,
        note:'Disponibile solo su copertura Open Fiber. Prezzo promozionale per 12 mesi. Nessun vincolo.'
      }
    ],

/* WiFi Business ‚Äì SKY WIFI BB */
businessWifi:[
      {
        id:'BIZ_WIFI_BB',
        name:'Sky WiFi BB Business',
        match:()=>true,
        // Canone: 24,50‚Ç¨ + IVA = 29,89‚Ç¨ ivato
        price:'29,89‚Ç¨ (24,50‚Ç¨ + IVA)',
        priceValue:29.89,
        // Attivazione: 29‚Ç¨ + IVA = 35,38‚Ç¨ ivato
        attivazione:'35,38‚Ç¨ (29‚Ç¨ + IVA)',
        // Codici voce business
        codiceVoce:{
          consumo:'1401041',    // chiamate a consumo
          unlimited:'1401056'   // chiamate unlimited incluse 12 mesi
        },
        scadenza:'‚Äî',
        durata:'12 mesi',
        note:'Offerta business SKY WIFI BB: canone 24,50‚Ç¨ + IVA (29,89‚Ç¨ ivato) per 12 mesi; attivazione 29‚Ç¨ + IVA (35,38‚Ç¨ ivato).'
      }
    ]
  
  };
  /* ================== STATE & UI ================== */
  const state = { tipo:null, off:null, voce:null, tv:new Set(), nf:'none' }

  function syncBlocks(){
    const off = state.off
    qs('#voiceBlock').style.display = (off==='wifi' || off==='wifi_tv' || off==='upsell_wifi') ? 'block' : 'none'
    qs('#tvBlock').style.display    = (off==='only_tv' || off==='wifi_tv' || off==='wifi_tv_glass') ? 'block' : 'none'
  }
  const scrollToResult = () => qs('#result').scrollIntoView({behavior:'smooth',block:'start'})

  const promoCard = qs('#promoCard');
  const promoBtn  = qs('#promoBtn');

  if (promoBtn && promoCard) {
    promoBtn.addEventListener('click', () => {
      const show = promoCard.style.display !== 'block';
      promoCard.style.display = show ? 'block' : 'none';
      if (show) {
        promoCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  }

  qs('#tipoCliente').addEventListener('change', e=>{ state.tipo=e.target.value })
  qs('#offerta').addEventListener('change', e=>{ state.off=e.target.value; syncBlocks() })
  ;(function(){ const t=qs('#tipoCliente'); const o=qs('#offerta'); if(t&&t.value) state.tipo=t.value; if(o&&o.value) state.off=o.value; syncBlocks() })()

  // Limitazione opzioni offerta per cliente BUSINESS
  qs('#tipoCliente').addEventListener('change', e=>{
    const tipo = e.target.value;
    const selOff = qs('#offerta');
    const opts = qsa('#offerta option');

    if (tipo === 'business') {
      // Mostra SOLO SKY WIFI (BB Business) nel menu offerta
      opts.forEach(opt=>{
        if (!opt.value) return; // lascia il placeholder
        if (opt.value !== 'wifi') {
          opt.disabled = true;
          opt.hidden   = true;
        } else {
          opt.disabled = false;
          opt.hidden   = false;
        }
      });

      // Imposta automaticamente l‚Äôofferta su SKY WIFI BB
      if (selOff.value !== 'wifi') {
        selOff.value = 'wifi';
        state.off = 'wifi';
        syncBlocks();
      }
    } else {
      // Ritorno a PRIVATO: riabilita tutte le offerte
      opts.forEach(opt=>{
        if (!opt.value) return;
        opt.disabled = false;
        opt.hidden   = false;
      });
      selOff.value = '';
      state.off = null;
      syncBlocks();
    }
  });


  document.addEventListener('click',(e)=>{
    const btn = e.target.closest('.chip'); if(!btn) return
    const group = btn.dataset.group, value = btn.dataset.value
    if(group==='voce'){
      qsa('#chipsVoce .chip').forEach(b=>b.setAttribute('aria-pressed','false'))
      btn.setAttribute('aria-pressed','true'); state.voce=value
    }else if(group==='nf'){
      qsa('#chipsNF .chip').forEach(b=>b.setAttribute('aria-pressed','false'))
      btn.setAttribute('aria-pressed','true'); state.nf=value
    }else if(group==='tv'){
      const pressed = btn.getAttribute('aria-pressed')==='true'
      btn.setAttribute('aria-pressed', String(!pressed))
      if(pressed) state.tv.delete(value); else state.tv.add(value)
    }
  })

  /* ================== HELPERS ================== */
  function composeTVListino(sel, nf){
    let subtotal = 0; const breakdown = []
    if(nf && nf!=='none'){
      const nfv = LISTINO.base.netflix[nf]||0;
      subtotal += nfv; breakdown.push(`Sky TV + Netflix ${nfLabel(nf)} ${nfv.toFixed(2)}‚Ç¨`)
    } else {
      subtotal += LISTINO.base.sky_tv; breakdown.push(`Sky TV ${LISTINO.base.sky_tv.toFixed(2)}‚Ç¨`)
    }
    const P = LISTINO.base.pacchetti; const L={sport:'Sport',cinema:'Cinema',calcio:'Calcio',kids:'Kids',uhd:'UHD/4K'}
    ;['sport','cinema','calcio','kids','uhd'].forEach(p=>{
      if(sel.has(p)){ const add=P[p]||0; subtotal+=add; if(add>0) breakdown.push(`${L[p]} ${add.toFixed(2)}‚Ç¨`) }
    })
    if(sel.has('sport') && !sel.has('uhd')){
      const add = P.uhd || 0; if(add>0){ subtotal += add; breakdown.push(`UHD/4K ${add.toFixed(2)}‚Ç¨ (con Sport)`) }
    }
    return {subtotal:Number(subtotal.toFixed(2)), breakdown}
  }

  /* === EXTRA per PROMO 3P: prezzi fissi indicati da te === */
  const THREEP_PACK_UPCHARGE = { calcio:8.00, sport:22.90, cinema:10.00, kids:5.00 };
  function computeExtra3P(base, sel, nf){
    const included = new Set(base.included||[]);
    let extra = 0; const breakdown=[];

    // Pacchetti mancanti ai prezzi fissi
    (['calcio','sport','cinema','kids']).forEach(p=>{
      if(sel.has(p) && !included.has(p)){
        const add = THREEP_PACK_UPCHARGE[p] || 0;
        if(add>0){ extra += add; breakdown.push(`${p[0].toUpperCase()+p.slice(1)} ${add.toFixed(2)}‚Ç¨`) }
      }
    });

    // Regola UHD con Sport: se l'offerta base NON include UHD e l'utente sceglie Sport (o √® incluso Sport nel base senza UHD)
    const baseHasUhd   = included.has('uhd');
    const userWantsSpt = sel.has('sport') || included.has('sport');
    if(userWantsSpt && !baseHasUhd && !sel.has('uhd')){
      const add = LISTINO.base.pacchetti.uhd || 0;
      if(add>0){ extra += add; breakdown.push(`UHD/4K ${add.toFixed(2)}‚Ç¨ (con Sport)`) }
    }

    // Netflix: sovrapprezzi fissi per promo 3P
    if(nf && nf!=='none'){
      const delta = THREEP_NF_UPCHARGE[nf] || 0;
      if(delta>0){ extra += delta; breakdown.push(`Netflix ${nfLabel(nf)} +${delta.toFixed(2)}‚Ç¨`) }
    }

    return { extra:Number(extra.toFixed(2)), breakdown };
  }

    /* Per PROMO non 3P (TV-only, GLASS, ecc.):
     ora Netflix usa gli stessi sovrapprezzi fissi delle 3P
     quando NON √® gi√† incluso nella promo. */
     function computeExtraAgainstIncluded(base, sel, nf){
    const P = LISTINO.base.pacchetti;
    const L = { sport:'Sport', cinema:'Cinema', calcio:'Calcio', kids:'Kids', uhd:'UHD/4K' };
    const included = new Set(base.included || []);
    let extra = 0;
    const breakdown = [];

    // Pacchetti TV aggiuntivi rispetto a quelli gi√† inclusi
    ['sport','cinema','calcio','kids','uhd'].forEach(p => {
      if (sel.has(p) && !included.has(p)) {
        const add = P[p] || 0;
        if (add > 0) {
          extra += add;
          breakdown.push(`${L[p]} ${add.toFixed(2)}‚Ç¨`);
        }
      }
    });

    // Netflix
    if (nf && nf !== 'none') {
      if (base.includedNetflix) {
        // Se la promo include gi√† un livello di Netflix (es. "base"),
        // applico la differenza di listino tra il livello desiderato e quello incluso.
        const current = LISTINO.base.netflix[base.includedNetflix] || 0;
        const wanted  = LISTINO.base.netflix[nf] || 0;
        const delta   = Math.max(0, wanted - current);
        if (delta > 0) {
          extra += delta;
          breakdown.push(`Netflix ${nfLabel(nf)} +${delta.toFixed(2)}‚Ç¨`);
        }
      } else {
        // Promo senza Netflix incluso: uso i sovrapprezzi fissi
        // (4,99 / 11,99 / 17,99) come per le 3P.
        let delta = THREEP_NF_UPCHARGE[nf] || 0;

        // Fallback di sicurezza: se per qualche motivo non c'√® l'upcharge,
        // ritorno alla logica "listino - Sky TV".
        if (!delta) {
          const wanted = LISTINO.base.netflix[nf] || 0;
          const current = LISTINO.base.sky_tv;
          delta = Math.max(0, wanted - current);
        }

        if (delta > 0) {
          extra += delta;
          breakdown.push(`Netflix ${nfLabel(nf)} +${delta.toFixed(2)}‚Ç¨`);
        }
      }
    }

    // UHD auto con Sport se non gi√† incluso
    if (sel.has('sport') && !included.has('uhd') && !sel.has('uhd')) {
      const add = P.uhd || 0;
      if (add > 0) {
        extra += add;
        breakdown.push(`UHD/4K ${add.toFixed(2)}‚Ç¨ (con Sport)`);
      }
    }

    return { extra: Number(extra.toFixed(2)), breakdown };
  }


  /* ================== CORE: COMPUTE BEST ================== */
  function computeBest(){
    if(!state.tipo || !state.off) return {error:'Seleziona tipologia cliente e offerta richiesta.'}
    const off = state.off, sel=new Set(state.tv), voce=state.voce, nf=state.nf
    let candidates=[]

    if(state.tipo==='business' && off==='wifi'){
      candidates = PROMO.businessWifi.map(p=>({base:p,total:p.priceValue,breakdown:[],extra:0}))
    }
    else if(off==='wifi_tv'){ /* 3P ‚Äì senza promo Calcio 29,90 */
      if(!voce) return {error:'Seleziona l\'opzione Voce (a consumo/unlimited).'}

      const base3P = PROMO.threeP.find(p => p.id === '3P_BASE')
      const others = PROMO.threeP.filter(p => p.id !== '3P_BASE' && p.match(sel, nf))
      const list   = [base3P].filter(Boolean).concat(others)

      candidates = list.map(p => {
        const { extra, breakdown } = computeExtra3P(p, sel, nf)
        return { base:p, total: Number((p.priceValue + extra).toFixed(2)), breakdown, extra }
      })

      // Ordinamento: prezzo asc, poi numero di pacchetti inclusi (discendente)
      candidates.sort((a,b)=>{
        if (a.total !== b.total) return a.total - b.total
        const aInc = (a.base.included||[]).length, bInc = (b.base.included||[]).length
        return bInc - aInc
      })
    }

    else if(off==='wifi_tv_glass'){
      const list = PROMO.glassThreeP
        .filter(p => p.match(sel, nf))
        .concat(PROMO.glassThreeP.filter(p => !p.match(sel, nf)))
      candidates = list.map(p=>{
        const { extra, breakdown } = computeExtraAgainstIncluded(p, sel, nf)
        return { base:p, total:Number((p.priceValue+extra).toFixed(2)), breakdown, extra }
      })
    }
    else if(off==='wifi'){
      if(!voce) return {error:'Seleziona l\'opzione Voce (a consumo/unlimited).'}
      const main = PROMO.wifi.find(x=>x.id==='WIFI_MAIN')
      const of   = PROMO.wifi.find(x=>x.id==='WIFI_OF')
      const voceKey = voce || 'consumo'
      const best = {
        ...main, totalValue: main.priceValue, isPromo:true,
        codice: main.codiceVoce ? (main.codiceVoce[voceKey] || Object.values(main.codiceVoce)[0]) : '‚Äî',
        durata:'Senza vincoli', noCommitment:true
      }
      const alt = {
        ...of, totalValue: of.priceValue, isPromo:true,
        codice: of.codiceVoce ? (of.codiceVoce[voceKey] || Object.values(of.codiceVoce)[0]) : '‚Äî',
        durata:'Senza vincoli', noCommitment:true
      }
      return {best, context:'wifi', alt}
    }
    else if(off==='upsell_wifi'){
      if(!voce) return {error:'Seleziona l\'opzione Voce (a consumo/unlimited).'}
      const main = PROMO.wifi.find(x=>x.id==='WIFI_MAIN')
      const of   = PROMO.wifi.find(x=>x.id==='WIFI_OF')
      const voceKey = voce || 'consumo'
      const best = {
        ...main, id:'UPSELL_WIFI', name:'Upsell WiFi (gi√† cliente TV) ¬∑ Senza vincoli',
        totalValue: main.priceValue, isPromo:true, durata:'Senza vincoli', noCommitment:true,
        codice: main.codiceVoce ? (main.codiceVoce[voceKey] || Object.values(main.codiceVoce)[0]) : '‚Äî',
        note: 'Solo per gi√† clienti TV.'
      }
      const alt  = {
        ...of, totalValue: of.priceValue, isPromo:true, durata:'Senza vincoli', noCommitment:true,
        codice: of.codiceVoce ? (of.codiceVoce[voceKey] || Object.values(of.codiceVoce)[0]) : '‚Äî'
      }
      return {best, context:'upsell_wifi', alt}
    }
    else if(off==='only_tv'){
      candidates = PROMO.tvOnly.filter(p=>p.match(sel,nf)).map(p=>{
        const { extra, breakdown } = computeExtraAgainstIncluded(p, sel, nf)
        return {base:p,total:Number((p.priceValue+extra).toFixed(2)), breakdown, extra}
      })
      candidates.sort((a,b)=> a.total - b.total)
    }

    if(candidates.length){
      const ch=candidates[0];
      const best={...ch.base};
      best.totalValue=ch.total; best.breakdown=ch.breakdown; best.isPromo=true; best.extraMonthly = ch.extra || 0;
      if(best.codiceVoce){ const voceKey=state.voce||'consumo'; best.codice = best.codiceVoce[voceKey] || Object.values(best.codiceVoce)[0] }
      return {best}
    }

    // fallback listino composito se 3P non matcha (usa WiFi MAIN + TV listino)
    if(off==='wifi_tv'){
      const wifiBest = PROMO.wifi.find(x=>x.id==='WIFI_MAIN');
      const tv=composeTVListino(sel,nf);
      const total=Number((wifiBest.priceValue+tv.subtotal).toFixed(2));
      const voceKey=state.voce||'consumo';
      const best={ id:'LIST_3P', name:`Composizione listino: ${wifiBest.name} + Sky TV`, priceValue:total, totalValue:total,
        attivazione:(wifiBest.attivazione||'-')+' + Stream 19‚Ç¨',
        codice:(wifiBest.codiceVoce?(wifiBest.codiceVoce[voceKey]||Object.values(wifiBest.codiceVoce)[0]):'‚Äî'),
        scadenza:wifiBest.scadenza||'‚Äî', durata:'‚Äî', note:'Composizione WiFi promo + TV a listino.',
        breakdown:[`${wifiBest.name} ${wifiBest.priceValue.toFixed(2)}‚Ç¨`].concat(tv.breakdown), extraMonthly:0};
      return {best}
    }

    if(off==='only_tv'){
      const tv=composeTVListino(sel,nf);
      const best={ id:'LIST_TV', name:(nf!=='none'?`Composizione listino: Sky TV + Netflix ${nfLabel(nf)}`:'Composizione listino: Sky TV'),
        priceValue:tv.subtotal, totalValue:tv.subtotal, attivazione:'Stream 19‚Ç¨', codice:'‚Äî', scadenza:'‚Äî', durata:'‚Äî',
        note:'Combinazione da listino (Sky TV + pacchetti + Netflix).', breakdown:tv.breakdown, extraMonthly:0 };
      return {best}
    }

    return {error:'Nessuna combinazione disponibile.'}
  }

  /* ================== RENDER ================== */
  function extractMonths(str){ if(!str) return null; const m = String(str).match(/(\d+)\s*mesi/i); return m ? parseInt(m[1],10) : null }
  function sumExtrasFromBreakdown(breakdown){
    if(!breakdown || !breakdown.length) return 0;
    return breakdown.reduce((acc, item)=>{
      const m = String(item).replace(',','.').match(/([\d.]+)\s*‚Ç¨/);
      return acc + (m ? parseFloat(m[1]) : 0);
    },0);
  }
  function nfIncludedText(best){ return best.includedNetflix ? `Sky TV + Netflix ${nfLabel(best.includedNetflix)}` : 'Sky TV' }
  function buildCompositionText(best){
    let base = nfIncludedText(best);
    const inc = new Set(best.included||[]);
    const order = ['sport','cinema','calcio','kids','uhd'];
    const map = {sport:'Sport',cinema:'Cinema',calcio:'Calcio',kids:'Kids',uhd:'UHD/4K'};
    order.forEach(p=>{ if(inc.has(p)) base += ` + ${map[p]}` });
    return base;
  }

  function renderWiFiAlternative(alt){
    const box = qs('#wifiAlternatives'); if(!alt){ box.style.display='none'; box.innerHTML=''; return }
    box.style.display='block';
    box.innerHTML = `
      <div class="offerAlt">
        <div class="head">
          <div class="title">Alternativa: ${alt.name}</div>
          <div class="price">${formatEUR(alt.totalValue)}</div>
        </div>
        <div class="meta">
          <span>Attivazione ${alt.attivazione||'-'}</span>
          <span>Codice ${alt.codice||'-'}</span>
          <span>Scadenza ${alt.scadenza||'-'}</span>
          <span>Durata: ${alt.durata||'-'}</span>
        </div>
        <div class="notes"><b>Note:</b> ${alt.note||'-'}</div>
      </div>`;
  }

  function renderResult(r){
    const noRes=qs('#noResult'), res=qs('#result');
    if(r.error){ noRes.style.display='block'; noRes.textContent=r.error; res.style.display='none'; return }
    noRes.style.display='none'; res.style.display='block'

    const nameEl=qs('#bestName');
    const isGlass = r.best.id?.startsWith('GLASS_')
    if(r.best.isPromo && !String(r.best.id).startsWith('LIST_')){
      nameEl.innerHTML = `${r.best.name} <span class="badge" style="margin-left:8px">Promo del momento</span>${isGlass?` <span class="pill glass">GLASS incluso ¬∑ 199‚Ç¨</span>`:''}`
    } else if(String(r.best.id).startsWith('LIST_')){
      nameEl.innerHTML = `${r.best.name} <span class="pill">Prezzo di listino</span>`
    } else { nameEl.textContent = r.best.name }

    const total = typeof r.best.totalValue==='number' ? r.best.totalValue : (r.best.priceValue||0)
    qs('#priceAmount').textContent = formatEUR(total)
    qs('#attivazione').textContent = r.best.attivazione || '-'
    qs('#codice').textContent = r.best.codice || '-'
    qs('#scadenza').textContent = r.best.scadenza || '-'
    qs('#glassKpi').style.display = isGlass ? 'block' : 'none'

    const fBox = qs('#formulaBox');
    if(r.best.breakdown && r.best.breakdown.length){
      fBox.style.display='inline-block';
      fBox.innerHTML = `<b>Formula:</b> ${r.best.breakdown.join(' + ')} = <b>${formatEUR(total)}</b>`
    } else { fBox.style.display='none' }

    const priceDet = qs('#priceDetail');
    let baseSentence = '';
    if (r.best.noCommitment || /senza\s*vincoli/i.test(String(r.best.durata||''))) {
      baseSentence = `Canone: ${r.best.price || formatEUR(r.best.totalValue)} ¬∑ Senza vincoli`;
    } else if(r.best.isPromo && r.best.price) {
      baseSentence = `Promo base: ${r.best.price}${r.best.durata?` per ${r.best.durata}`:''}`
    } else if(String(r.best.id).startsWith('LIST_')){
      baseSentence = 'Prezzo di listino (Smart)'
    }
    const addSentence = (r.best.breakdown && r.best.breakdown.length) ? `Aggiunte: ${r.best.breakdown.join(' + ')} al mese` : ''
    const glassSentence = isGlass ? 'DISPOSITIVO INCLUSO: SKY GLASS 43" Nero ‚Äì costo una tantum 199‚Ç¨ (consegna gratuita).' : ''
    priceDet.textContent = [baseSentence, glassSentence, addSentence].filter(Boolean).join(' ¬∑ ')

    const comp = (r.best.breakdown && r.best.breakdown.length) ? `<br/><b>Voci aggiunte:</b> ${r.best.breakdown.join(' + ')}`
                          : ''
    const glassNote = isGlass ? ' ¬∑ SKY GLASS 43" Nero incluso nel bundle ¬∑ 199‚Ç¨ una tantum.' : ''
    qs('#note').innerHTML = `<b>Note:</b> ${r.best.note||'-'}${glassNote}${r.best.durata?` ¬∑ Durata promo: ${r.best.durata}`:''}${comp}`

    const recap = qs('#recapBox');
    const compText = buildCompositionText(r.best);
    const extrasSum = r.best.extraMonthly ?? sumExtrasFromBreakdown(r.best.breakdown);
    const att = r.best.attivazione || '‚Äî';

    let vincolo, durata;
    if (r.best.noCommitment || /senza\s*vincoli/i.test(String(r.best.durata||''))) { vincolo = '‚Äî'; durata = '‚Äî'; }
    else { durata  = extractMonths(r.best.durata) || extractMonths(r.best.price) || (String(r.best.id).startsWith('WIFI') ? 12 : 18); vincolo = (String(r.best.id).startsWith('WIFI') ? 12 : 18); }

    recap.innerHTML = `
      <h4>Composizione offerta</h4>
      <div class="recap-grid">
        <div class="recap-label">Sky TV / Bundle</div><div class="recap-value">${compText}</div>
        <div class="recap-label">+ Pacchetti / Opzioni</div><div class="recap-value">${extrasSum>0?`+${formatEUR(extrasSum)}`:'‚Äî'}</div>
        <div class="recap-label">Dispositivo</div><div class="recap-value">${isGlass ? 'SKY GLASS 43&quot; Nero (incluso) ¬∑ 199‚Ç¨ una tantum' : '‚Äî'}</div>
        <div class="recap-label">Attivazione</div><div class="recap-value">${att}</div>
        <div class="recap-label">Vincolo (mesi)</div><div class="recap-value">${vincolo}</div>
        <div class="recap-label">Durata offerta (mesi)</div><div class="recap-value">${durata}</div>
      </div>
      <div class="recap-badges">
        ${r.best.isPromo?'<span class="badge">Promo del momento</span>':''}
        ${isGlass?'<span class="pill glass">GLASS incluso ¬∑ 199‚Ç¨</span>':''}
        ${(r.best.breakdown&&r.best.breakdown.length)?`<span class="badge">Formula: ${r.best.breakdown.join(' + ')}</span>`:''}
      </div>`;
    recap.style.display='block';

    renderWiFiAlternative(r.alt);
    qs('#contractCta').style.display = 'block';
    scrollToResult();
  }

  /* ================== EVENTS ================== */
  function runCalc(){ renderResult(computeBest()) }
  qs('#calcBtn')?.addEventListener('click', runCalc)
  qs('#calcBtnMb')?.addEventListener('click', runCalc)
  qs('#resetBtn').addEventListener('click', ()=> location.reload())
  qs('#copyCode').addEventListener('click', ()=>{
    const code=qs('#codice').textContent.trim(); if(!code||code==='-') return; navigator.clipboard.writeText(code)
  })

  /* ================== RECESSO ================== */
  const COSTI_RECESSO = {
    tv:  [10.10,20.20,30.30,40.40,50.50,50.50,50.50,50.50,50.50,50.50,50.50,50.50,50.50,40.40,30.30,20.20,10.10,0.00],
    tv1: [14.10,28.20,42.30,56.40,70.50,70.50,70.50,70.50,70.50,70.50,70.50,70.50,70.50,56.40,42.30,28.20,14.10,0.00],
    tv2: [18.10,36.20,54.30,72.40,90.50,90.50,90.50,90.50,90.50,90.50,90.50,90.50,90.50,72.40,54.30,36.20,18.10,0.00],
    tv3: [22.10,44.20,66.30,88.40,110.50,110.50,110.50,110.50,110.50,110.50,110.50,110.50,110.50,88.40,66.30,44.20,22.10,0.00],
  };
  document.addEventListener('click',(ev)=>{
    const btn = ev.target.closest('#calcRecesso'); if(!btn) return;
    const meseSel = parseInt(qs('#mesiTrascorsi').value,10);
    const packSel = qs('#nPacchetti').value;
    if(!meseSel || !packSel){ alert('Seleziona mese e configurazione pacchetti.'); return; }
    const arr = COSTI_RECESSO[packSel] || [];
    const idx = Math.min(Math.max(meseSel,1),18)-1;
    const valore = arr[idx] ?? 0;
    const box = qs('#resRecesso');
    qs('#totRecesso').textContent = formatEUR(valore);
    box.style.display='block';
    box.scrollIntoView({behavior:'smooth', block:'center'});
    const labelPack = {tv:'Sky TV', tv1:'Sky TV + 1 pack', tv2:'Sky TV + 2 pack', tv3:'Sky TV + 3 pack'}[packSel];
    qs('#detailRecesso').textContent = `Mese ${meseSel}¬∞ ¬∑ Configurazione: ${labelPack} ¬∑ Valore tabellare: ${formatEUR(valore)}.`;
  });

  /* ================== DATASET DIALOG ================== */
  const datasetDlg=qs('#datasetDlg')
  function openDataset(){
    const DATA={ PACCHETTI:LISTINO.base.pacchetti, NETFLIX:{prezzi:LISTINO.base.netflix, labels:NF_LABEL, note:NF_NOTE}, THREEP_UPCHARGE:{packs:THREEP_PACK_UPCHARGE, netflix:THREEP_NF_UPCHARGE}, PROMO }
    qs('#datasetPre').textContent = JSON.stringify(DATA,null,2);
    datasetDlg.showModal()
  }
  qs('#listinoBtn')?.addEventListener('click', openDataset)
  qs('#listinoBtnMb')?.addEventListener('click', openDataset)
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Piattaforma Offerte SKY – v4.3</title>
  <style>
    :root{
      --bg:#f7f9ff; --card:#ffffff; --muted:#eef2ff; --text:#111827; --sub:#5b6b8b;
      --accent:#e31c79; --accent2:#0c64c5; --good:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      --ring:0 0 0 3px rgba(12,100,197,.25); --border:#e6e9f5; --shadow:0 10px 30px rgba(17,24,39,.08)
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(180deg,#f7f9ff,#f3f7ff 40%,#eef4ff 100%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 10px 24px rgba(12,100,197,.25)}
    h1{font-size:22px;margin:0;font-weight:800}

    .form-card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:18px}
    .form-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .form-title{display:flex;align-items:center;gap:10px}
    .step{width:26px;height:26px;display:inline-grid;place-items:center;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-weight:800;font-size:13px}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:820px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:13px;color:#344052;margin:0 0 6px 2px;font-weight:700}
    select{width:100%;background:#fff;color:var(--text);border:1px solid var(--border);padding:12px;border-radius:12px;outline:none;font-size:14px;transition:box-shadow .2s,border-color .2s}
    select:focus{box-shadow:var(--ring);border-color:#96b8ff}

    .chips{display:flex;flex-wrap:wrap;gap:8px;padding:10px;background:var(--muted);border-radius:14px;border:1px solid var(--border)}
    .chip{appearance:none;border:1px solid #dbe1f4;padding:9px 12px;border-radius:999px;font-size:13px;cursor:pointer;background:#fff;white-space:nowrap}
    .chip[aria-pressed="true"]{background:linear-gradient(135deg,var(--accent),var(--accent2));border-color:transparent;color:#fff;font-weight:800}

    .btn{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(12,100,197,.25)}
    .btn.secondary{background:#fff;color:#0c64c5;border:1px solid #cfe1ff}

    .results{margin-top:16px}
    .result-card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:22px}
    .result-head{display:flex;align-items:flex-start;justify-content:space-between;gap:18px}
    .result-name{font-size:20px;font-weight:900}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
    @media(max-width:820px){.kpis{grid-template-columns:1fr}}
    .kpi{background:#f3f8ff;border:1px solid #d9e6ff;border-radius:12px;padding:12px}
    .kpi b{font-size:18px}
    .code{font-family:ui-monospace,monospace;background:#fff;border:1px solid #e5e9f6;padding:10px 12px;border-radius:10px}
    .notes{margin-top:12px;padding-top:12px;border-top:1px dashed #e2e8f8;color:#4b5875;font-size:13px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eaf2ff;border:1px solid #cfe1ff;color:#0c64c5;font-size:12px;font-weight:800}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid #ffd9a6;background:#fff5e6;color:#9a6b00;font-size:12px;font-weight:800}
    .pill.glass{border-color:#b8e1ff;background:#eef7ff;color:#0c64c5}

    .priceCard{background:#f3f8ff;border:1px solid #d9e6ff;border-radius:12px;padding:14px 18px;display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:260px}
    .priceValue{font-size:52px;line-height:1;font-weight:900;letter-spacing:.5px}
    .priceLabel{font-size:12px;color:#6a7aa0;letter-spacing:.08em;text-transform:uppercase;margin-top:4px}
    .priceDetail{margin-top:8px;font-size:13px;color:#2f3b57;text-align:center}

    .altContainer{margin-top:14px}
    .offerAlt{background:#f9fbff;border:1px solid #d9e6ff;border-radius:16px;padding:16px 18px;display:flex;flex-direction:column;gap:10px;min-height:150px}
    .offerAlt .head{display:flex;align-items:baseline;justify-content:space-between;gap:12px}
    .offerAlt .title{font-weight:800;font-size:16px;color:#1c274c}
    .offerAlt .price{font-size:28px;font-weight:900;letter-spacing:.2px}
    .offerAlt .meta{display:flex;flex-wrap:wrap;gap:10px;color:#415079}
    .offerAlt .meta span{background:#fff;border:1px solid #e5e9f6;border-radius:10px;padding:8px 10px;font-size:13px}
    .offerAlt .foot{margin-top:auto;display:flex;align-items:center;gap:12px}
    .offerAlt .btn.cover{padding:12px 16px;border-radius:12px}

    #contractCta{text-align:right}

    .recap{margin-top:12px;border:1px dashed #e2e8f8;background:#f9fbff;border-radius:12px;padding:16px}
    .recap h4{margin:0 0 10px 0;font-size:14px;color:#3b4a6b}
    .recap-grid{display:grid;grid-template-columns:1fr auto;row-gap:10px;column-gap:16px;align-items:center}
    .recap-label{color:#617094;font-size:13px}
    .recap-value{font-weight:800}
    .recap-badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* highlight recesso */
    .pulse{animation:pulse 1.4s ease-in-out 1}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(12,100,197,.25)}70%{box-shadow:0 0 0 12px rgba(12,100,197,0)}100%{box-shadow:none}}

    @media (max-width:640px){
      .wrap{padding:0 12px}
      header{gap:10px}
      h1{font-size:18px}
      .form-card{padding:14px;border-radius:16px}
      .form-header{flex-direction:column;align-items:flex-start;gap:6px}
      .row{gap:10px}
      .chips{overflow-x:auto;flex-wrap:nowrap;gap:8px;padding:10px 8px}
      .result-card{padding:16px;border-radius:16px}
      .result-head{flex-direction:column;gap:12px}
      .result-name{font-size:18px}
      .priceCard{min-width:auto;width:100%;padding:12px}
      .priceValue{font-size:38px}
      .priceLabel{font-size:11px}
      .priceDetail{font-size:13px}
      .kpi b{font-size:16px}
      .btn,.btn.secondary{width:100%}
      #contractCta{padding:14px}
      .offerAlt{padding:14px}
      .offerAlt .price{font-size:24px}
      .offerAlt .meta span{font-size:12px}
      dialog{width:96%}
      .recap{padding:14px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><div class="logo"></div><div><h1>PROMO SKY IN CORSO</h1></div></div>
      <button class="btn secondary" id="resetBtn">Pulisci</button>
    </header>

    <section class="form-card" id="formCard">
      <div class="form-header">
        <div class="form-title"><span class="step">1</span><b>Dati di richiesta</b></div>
        <div class="muted">Compila i campi e premi <b>Calcola offerta</b>.</div>
      </div>

      <div class="row">
        <div>
          <label>Tipologia cliente</label>
          <select id="tipoCliente">
            <option value="" selected disabled>Seleziona…</option>
            <option value="privato">Privato</option>
          </select>
        </div>
        <div>
          <label>Offerta richiesta</label>
          <select id="offerta">
            <option value="" selected disabled>Seleziona…</option>
            <option value="only_tv">Only TV</option>
            <option value="wifi">Sky Wifi</option>
            <option value="upsell_wifi">Upsell Wifi (già cliente TV)</option>
            <option value="wifi_tv">Sky Wifi + TV (3P)</option>
            <option value="wifi_tv_glass">Sky wifi + Tv (3P) con GLASS</option>
          </select>
        </div>
      </div>

      <div id="voiceBlock" style="display:none; margin-top:12px;">
        <label>Opzione Voce (solo per Sky Wifi o 3P)</label>
        <div class="chips" id="chipsVoce">
          <button class="chip" data-group="voce" data-value="consumo" aria-pressed="false">Voce a consumo</button>
          <button class="chip" data-group="voce" data-value="unlimited" aria-pressed="false">Voce Unlimited</button>
        </div>
      </div>

      <div id="tvBlock" style="display:none; margin-top:12px;">
        <div class="row">
          <div>
            <label>Pacchetti TV</label>
            <div class="chips" id="chipsTV">
              <button class="chip" data-group="tv" data-value="calcio" aria-pressed="false">Calcio</button>
              <button class="chip" data-group="tv" data-value="sport" aria-pressed="false">Sport</button>
              <button class="chip" data-group="tv" data-value="cinema" aria-pressed="false">Cinema</button>
              <button class="chip" data-group="tv" data-value="kids" aria-pressed="false">Kids</button>
              <button class="chip" data-group="tv" data-value="uhd" aria-pressed="false">UHD/4K</button>
            </div>
          </div>
          <div>
            <label>Netflix</label>
            <div class="chips" id="chipsNF">
              <button class="chip" data-group="nf" data-value="none" aria-pressed="true">Nessuno</button>
              <button class="chip" data-group="nf" data-value="base" aria-pressed="false">Base</button>
              <button class="chip" data-group="nf" data-value="standard" aria-pressed="false">Standard</button>
              <button class="chip" data-group="nf" data-value="premium" aria-pressed="false">Premium</button>
            </div>
          </div>
        </div>
        <div class="muted">Seleziona i pacchetti desiderati. Le promo TV/3P vengono proposte automaticamente.</div>
      </div>

      <div class="row" style="margin-top:12px">
        <div></div>
        <div style="text-align:right;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn secondary" id="listinoBtn" title="Visualizza dataset interno">Dataset</button>
          <button class="btn" id="calcBtn">Calcola offerta</button>
        </div>
      </div>
    </section>

    <section class="results" id="results">
      <div class="result-card" id="noResult">Nessun risultato ancora. Compila i campi sopra e premi <b>Calcola offerta</b>.</div>
      <div class="result-card" id="result" style="display:none">
        <div class="result-head">
          <div>
            <div class="muted">Promo consigliata</div>
            <div class="result-name" id="bestName">-</div>
            <div id="formulaBox" class="badge" style="display:none;margin-top:10px"></div>
          </div>
          <div class="kpi" style="justify-self:end">
            <div class="priceCard">
              <div class="priceValue" id="priceAmount">—</div>
              <div class="priceLabel">CANONE MENSILE</div>
            </div>
            <div id="priceDetail" class="priceDetail"></div>
          </div>
        </div>

        <div id="recapBox" class="recap" style="display:none"></div>

        <div class="kpis">
          <div class="kpi">
            <div class="muted">Costo di attivazione</div>
            <b id="attivazione">-</b>
          </div>
          <div class="kpi">
            <div class="muted">Codice attivazione</div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="code" id="codice">-</span>
              <button class="btn secondary" id="copyCode">Copia</button>
            </div>
          </div>
          <div class="kpi" id="glassKpi" style="display:none">
            <div class="muted">Dispositivo incluso</div>
            <b>SKY GLASS 43" Nero · 199€ una tantum</b>
          </div>
          <div class="kpi">
            <div class="muted">Scadenza promo</div>
            <b id="scadenza">-</b>
          </div>
        </div>
        <div class="notes" id="note"></div>

        <div id="wifiAlternatives" class="altContainer" style="display:none"></div>
      </div>

      <div class="result-card" id="contractCta" style="display:none">
        <a class="btn" href="http://myspace.e2kdistribution.com/" target="_blank" rel="noopener" style="width:100%">INSERISCI CONTRATTO</a>
      </div>
    </section>
    <script>
        (function(){
          const qs = s => document.querySelector(s)
          const qsa = s => Array.from(document.querySelectorAll(s))
          const formatEUR = n => new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(n)
        
          const LISTINO = {
            base:{
              sky_tv:14.90,
              netflix:{ base:19.90, standard:23.90, premium:27.90 },
              pacchetti:{ cinema:10.00, sport:22.90, calcio:8.00, kids:5.00, hd:5.00, uhd:5.00 }
            }
          }
        
          const PROMO = {
            tvOnly:[
              { id:'TV_SPORT_UHD', name:'SKY TV + SPORT + UHD',
                match:(s)=> s.has('sport'),
                price:'24,99€ per 6 mesi poi 29,99€', priceValue:24.99,
                included:['sport','uhd'], includedNetflix:null, attivazione:'Stream 19€',
                codice:'1100759', scadenza:'09/11/2025 (No backlog)', durata:'6 mesi promo',
                note:'Aggiunte possibili: Kids 5€, Calcio 8€, Cinema 10€.' },
              { id:'TV_NF_STD', name:'SKY TV + Netflix Standard (con pubblicità)',
                match:(_,nf)=> nf==='standard' || nf==='none',
                price:'15,99€', priceValue:15.99, included:[], includedNetflix:'standard',
                attivazione:'Stream 19€', codice:'1100766', scadenza:'09/11/2025 (No backlog)', durata:'18 mesi',
                note:'Aggiunte: Kids 5€, Calcio 8€, Cinema 10€, Sport 22,90€.' },
              { id:'TV_NF_STD_CIN', name:'SKY TV + Netflix Standard + CINEMA',
                match:(s,nf)=> (s.has('cinema')) && (nf==='standard' || nf==='none'),
                price:'15,99€ per 6 mesi poi 24,99€', priceValue:15.99,
                included:['cinema'], includedNetflix:'standard', attivazione:'Stream 19€',
                codice:'1100772', scadenza:'09/11/2025 (No backlog)', durata:'18 mesi (6+12)',
                note:'Include Cinema. Aggiunte: Kids 5€, Calcio 8€, Sport 22,90€.' },
              { id:'TV_CIN_CAL', name:'SKY TV + CINEMA + CALCIO',
                match:(s)=> s.has('cinema') && s.has('calcio'),
                price:'19,99€', priceValue:19.99, included:['cinema','calcio'], includedNetflix:null,
                attivazione:'Stream 19€', codice:'1100739', scadenza:'09/11/2025 (No backlog)', durata:'18 mesi',
                note:'Aggiunte: Kids 5€, Netflix Base +5€, Sport 22,90€.' }
            ],
            /* 3P standard + 3P Calcio 29,90 */
            threeP:[
              { id:'3P_TV_CALCIO', name:'3P + CALCIO (WiFi+TV+Calcio)',
                match:()=>true, price:'29,90€', priceValue:29.90, included:['calcio'],
                attivazione:'WiFi 0€ – Stream 19€', codiceVoce:{consumo:'1300216', unlimited:'1300217'},
                scadenza:'09/11/2025 (+2gg backlog)', durata:'18 mesi',
                note:'MOP: Carta o RID (no prepagata). Pack Calcio incluso al prezzo del 3P base.' },
              { id:'3P_CIN', name:'3P + CINEMA (TV+UHD+WiFi+Cinema)', match:(s)=> s.has('cinema'),
                price:'35,80€', priceValue:35.80, included:['cinema','uhd'],
                attivazione:'Stream 19€ – WiFi Gratis', codiceVoce:{consumo:'1300199',unlimited:'1300200'},
                scadenza:'01/12/2025 (+2gg backlog)', durata:'18 mesi',
                note:'Aggiunte: Kids 5€, Sport 22,90€, Netflix opzionale.' },
              { id:'3P_SPORT', name:'3P + SPORT (TV+UHD+WiFi+Sport)', match:(s)=> s.has('sport'),
                price:'35,80€', priceValue:35.80, included:['sport','uhd'],
                attivazione:'Stream 19€ – WiFi Gratis', codiceVoce:{consumo:'1300205',unlimited:'1300206'},
                scadenza:'01/12/2025 (+2gg backlog)', durata:'18 mesi',
                note:'Aggiunte: Kids 5€, Cinema 10€, Netflix opzionale.' },
              { id:'3P_BASE', name:'3P base (TV+WiFi, no pack)', match:(s)=> !s.has('sport') && !s.has('cinema') && !s.has('calcio'),
                price:'29,90€', priceValue:29.90, included:[],
                attivazione:'Stream 19€ – WiFi Gratis', codiceVoce:{consumo:'1300208',unlimited:'1300207'},
                scadenza:'01/12/2025 (No backlog)', durata:'18 mesi',
                note:'Pacchetti aggiuntivi a listino; Netflix opzionale.' }
            ],
            /* NUOVE GLASS */
            glassThreeP:[
              { id:'GLASS_CINEMA', name:'3P GLASS: TV + Cinema + 4K + Netflix Base',
                match:(s)=> s.has('cinema'),
                price:'40,89€', priceValue:40.89,
                included:['cinema','uhd'], includedNetflix:'base',
                attivazione:'WiFi Gratis – Consegna GLASS gratuita',
                codice:'1300220', scadenza:'10/12/2025', durata:'18 mesi',
                note:'SKY GLASS 43" Nero incluso nel bundle · costo in soluzione unica 199€ (una tantum).' },
              { id:'GLASS_BASE4K', name:'3P GLASS: TV + 4K + Netflix Base',
                match:(s)=> !s.has('sport') && !s.has('cinema'),
                price:'34,89€', priceValue:34.89,
                included:['uhd'], includedNetflix:'base',
                attivazione:'WiFi Gratis – Consegna GLASS gratuita',
                codice:'1300222', scadenza:'10/12/2025', durata:'18 mesi',
                note:'SKY GLASS 43" Nero incluso nel bundle · costo in soluzione unica 199€ (una tantum).' },
              { id:'GLASS_SPORT', name:'3P GLASS: TV + Sport + 4K + Netflix Base',
                match:(s)=> s.has('sport'),
                price:'40,89€', priceValue:40.89,
                included:['sport','uhd'], includedNetflix:'base',
                attivazione:'WiFi Gratis – Consegna GLASS gratuita',
                codice:'1300221', scadenza:'10/12/2025', durata:'18 mesi',
                note:'SKY GLASS 43" Nero incluso nel bundle · costo in soluzione unica 199€ (una tantum).' }
            ],
            wifi:[
              { id:'WIFI_STD', name:'Sky WiFi (Promo 12 mesi)', match:()=>true,
                price:'25,90€ (12 mesi) – listino 29,90€', priceValue:25.90,
                attivazione:'29,90€', codiceVoce:{consumo:'8122', unlimited:'8123'},
                scadenza:'28/12/2025 (+2gg backlog)',
                note:'Ultra WiFi +5€; Voce Unlimited +5€ (cod. 8123).' },
              { id:'WIFI_OF', name:'Sky WiFi – Open Fiber Only (Promo 12 mesi)', match:()=>true,
                price:'22,90€ (12 mesi)', priceValue:22.90,
                attivazione:'29,90€', codiceVoce:{consumo:'1401189', unlimited:'1401190'},
                scadenza:'28/12/2025 (+2gg backlog)',
                note:'OF Only. Ultra WiFi +5€. Voce Unlimited codice 1401190.' }
            ],
            businessWifi:[
              { id:'BIZ_WIFI_STD', name:'Sky WiFi Business', match:()=>true,
                price:'24,50€ + IVA (12 mesi)', priceValue:24.50,
                attivazione:'29,90€ + IVA', codiceVoce:{consumo:'1401041', unlimited:'1401061'},
                scadenza:'—', note:'Listino business standard.' },
              { id:'BIZ_WIFI_OF', name:'Sky WiFi Business – Open Fiber Only', match:()=>true,
                price:'21,50€ + IVA (12 mesi)', priceValue:21.50,
                attivazione:'29,90€ + IVA', codiceVoce:{consumo:'1401195', unlimited:'1401196'},
                scadenza:'28/12/2025 (+2gg backlog)',
                note:'Promo OF Only. Dopo 12 mesi: 24,51€ + IVA / 28,61€ + IVA.' }
            ]
          }
        
          const state = { tipo:null, off:null, voce:null, tv:new Set(), nf:'none' }
        
          function syncBlocks(){
            const off = state.off
            qs('#voiceBlock').style.display = (off==='wifi' || off==='wifi_tv' || off==='upsell_wifi') ? 'block' : 'none'
            qs('#tvBlock').style.display    = (off==='only_tv' || off==='wifi_tv' || off==='wifi_tv_glass') ? 'block' : 'none'
          }
        
          qs('#tipoCliente').addEventListener('change', e=>{ state.tipo=e.target.value })
          qs('#offerta').addEventListener('change', e=>{ state.off=e.target.value; syncBlocks() })
          ;(function(){ const t=qs('#tipoCliente'); const o=qs('#offerta'); if(t&&t.value) state.tipo=t.value; if(o&&o.value) state.off=o.value; syncBlocks() })()
        
          document.addEventListener('click', (e)=>{
            const btn = e.target.closest('.chip'); if(!btn) return
            const group = btn.dataset.group, value = btn.dataset.value
            if(group==='voce'){ qsa('#chipsVoce .chip').forEach(b=>b.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true'); state.voce=value }
            else if(group==='nf'){ qsa('#chipsNF .chip').forEach(b=>b.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true'); state.nf=value }
            else if(group==='tv'){ const pressed = btn.getAttribute('aria-pressed')==='true'; btn.setAttribute('aria-pressed', String(!pressed)); if(pressed) state.tv.delete(value); else state.tv.add(value) }
          })
        
          /* Listino TV con UHD obbligatorio se c'è Sport e non incluso */
          function composeTVListino(sel, nf){
            let subtotal = 0; const breakdown = []
            if(nf && nf!=='none'){ const nfv = LISTINO.base.netflix[nf]||0; subtotal += nfv; breakdown.push(`Sky TV + Netflix ${nf} ${nfv.toFixed(2)}€`) }
            else { subtotal += LISTINO.base.sky_tv; breakdown.push(`Sky TV ${LISTINO.base.sky_tv.toFixed(2)}€`) }
        
            const P = LISTINO.base.pacchetti; const L={sport:'Sport',cinema:'Cinema',calcio:'Calcio',kids:'Kids',uhd:'UHD/4K'}
            ;['sport','cinema','calcio','kids','uhd'].forEach(p=>{ if(sel.has(p)){ const add=P[p]||0; subtotal+=add; if(add>0) breakdown.push(`${L[p]} ${add.toFixed(2)}€`) } })
        
            if(sel.has('sport') && !sel.has('uhd')){
              const add = P.uhd || 0; if(add>0){ subtotal += add; breakdown.push(`UHD/4K ${add.toFixed(2)}€ (con Sport)`) }
            }
            return {subtotal:Number(subtotal.toFixed(2)), breakdown}
          }
        
          /* Extra rispetto a included[] (usato anche per GLASS) */
          function computeExtraAgainstIncluded(base, sel, nf){
            const P=LISTINO.base.pacchetti; const L={sport:'Sport',cinema:'Cinema',calcio:'Calcio',kids:'Kids',uhd:'UHD/4K'}
            const included = new Set(base.included||[]); let extra=0; const breakdown=[]
            ;['sport','cinema','calcio','kids','uhd'].forEach(p=>{
              if(sel.has(p) && !included.has(p)){ const add=P[p]||0; if(add>0){ extra+=add; breakdown.push(`${L[p]} ${add.toFixed(2)}€`) } }
            })
            if(nf && nf!=='none'){
              if(base.includedNetflix){
                const current=LISTINO.base.netflix[base.includedNetflix]||0; const wanted=LISTINO.base.netflix[nf]||0;
                const delta=Math.max(0,wanted-current); if(delta>0){ extra+=delta; breakdown.push(`Netflix upgrade +${delta.toFixed(2)}€`) }
              } else {
                const delta=Math.max(0,(LISTINO.base.netflix[nf]||0) - LISTINO.base.sky_tv);
                if(delta>0){ extra+=delta; breakdown.push(`Netflix ${nf} +${delta.toFixed(2)}€`) }
              }
            }
            if(sel.has('sport') && !included.has('uhd') && !sel.has('uhd')){
              const add = P.uhd || 0; if(add>0){ extra+=add; breakdown.push(`UHD/4K ${add.toFixed(2)}€ (con Sport)`) }
            }
            return {extra:Number(extra.toFixed(2)), breakdown}
          }
          function computeBest(){
    if(!state.tipo || !state.off) return {error:'Seleziona tipologia cliente e offerta richiesta.'}
    const off = state.off, sel=new Set(state.tv), voce=state.voce, nf=state.nf
    let candidates=[]

    if(state.tipo==='business' && off==='wifi'){
      candidates = PROMO.businessWifi.map(p=>({base:p,total:p.priceValue,breakdown:[],extra:0}))
    }
    else if(off==='wifi_tv'){ /* 3P standard (priorità 3P Calcio a 29,90 se richiede wifi+tv) */
      if(!voce) return {error:'Seleziona l\'opzione Voce (a consumo/unlimited).'}
      const calcio3P = PROMO.threeP.find(p => p.id === '3P_TV_CALCIO')
      const base3P   = PROMO.threeP.find(p => p.id === '3P_BASE')
      const others   = PROMO.threeP.filter(p => !['3P_TV_CALCIO','3P_BASE'].includes(p.id) && p.match(sel, nf))
      const list     = [calcio3P, base3P].filter(Boolean).concat(others)

      candidates = list.map(p => {
        const { extra, breakdown } = computeExtraAgainstIncluded(p, sel, nf)
        return { base: p, total: Number((p.priceValue + extra).toFixed(2)), breakdown, extra }
      })
    }
    else if(off==='wifi_tv_glass'){ /* GLASS */
      const list = PROMO.glassThreeP
        .filter(p => p.match(sel, nf))
        .concat(PROMO.glassThreeP.filter(p => !p.match(sel, nf)))
      candidates = list.map(p=>{
        const { extra, breakdown } = computeExtraAgainstIncluded(p, sel, nf)
        return { base:p, total:Number((p.priceValue+extra).toFixed(2)), breakdown, extra }
      })
    }
    else if(off==='wifi'){
      if(!voce) return {error:'Seleziona l\'opzione Voce (a consumo/unlimited).'}
      const std = PROMO.wifi.find(x=>x.id==='WIFI_STD')
      const of  = PROMO.wifi.find(x=>x.id==='WIFI_OF')
      const voceKey = voce || 'consumo'
      const best = {...std, totalValue: std.priceValue, isPromo:true, codice: std.codiceVoce ? (std.codiceVoce[voceKey] || Object.values(std.codiceVoce)[0]) : '—', durata:'12 mesi' }
      const alt  = {...of,  totalValue: of.priceValue,  isPromo:true, codice: of.codiceVoce ? (of.codiceVoce[voceKey]  || Object.values(of.codiceVoce)[0]) : '—', openFiber:true, durata:'12 mesi' }
      return {best, alternatives:[alt], context:'wifi'}
    }
    else if(off==='upsell_wifi'){
      if(!voce) return {error:'Seleziona l\'opzione Voce (a consumo/unlimited).'}
      const std = PROMO.wifi.find(x=>x.id==='WIFI_STD')
      const voceKey = voce || 'consumo'
      const best = {...std, id:'UPSELL_WIFI', name:'Upsell WiFi (già cliente TV)',
        totalValue: std.priceValue, isPromo:true, durata:'12 mesi',
        codice: std.codiceVoce ? (std.codiceVoce[voceKey] || Object.values(std.codiceVoce)[0]) : '—',
        note: 'Solo per già clienti TV. Verifica CF per eventuale offerta dedicata a 20,90€ per 12 mesi.'
      }
      return {best, context:'upsell_wifi'}
    }
    else if(off==='only_tv'){
      candidates = PROMO.tvOnly.filter(p=>p.match(sel,nf)).map(p=>{
        const { extra, breakdown } = computeExtraAgainstIncluded(p, sel, nf)
        return {base:p,total:Number((p.priceValue+extra).toFixed(2)), breakdown, extra}
      })
    }

    if(candidates.length){
      candidates.sort((a,b)=>{
        if (a.total !== b.total) return a.total - b.total
        const aInc = (a.base.included||[]).length, bInc = (b.base.included||[]).length
        if (aInc !== bInc) return bInc - aInc
        const sel = state.tv
        const aMatch = (a.base.included||[]).filter(x=>sel.has(x)).length
        const bMatch = (b.base.included||[]).filter(x=>sel.has(x)).length
        return bMatch - aMatch
      })
      const ch=candidates[0];
      const best={...ch.base};
      best.totalValue=ch.total; best.breakdown=ch.breakdown; best.isPromo=true; best.extraMonthly = ch.extra || 0;
      if(best.codiceVoce){ const voceKey=state.voce||'consumo'; best.codice = best.codiceVoce[voceKey] || Object.values(best.codiceVoce)[0] }
      return {best}
    }

    if(off==='only_tv'){
      const tv=composeTVListino(sel,nf);
      const best={ id:'LIST_TV', name: (nf!=='none'?`Composizione listino: Sky TV + Netflix ${nf}`:'Composizione listino: Sky TV'),
        priceValue:tv.subtotal, totalValue:tv.subtotal, attivazione:'Stream 19€', codice:'—', scadenza:'—', durata:'—',
        note:'Combinazione da listino (Sky TV + pacchetti + Netflix).', breakdown:tv.breakdown, extraMonthly:0 };
      return {best}
    }
    if(off==='wifi_tv'){
      const wifiBest = PROMO.wifi[1]||PROMO.wifi[0];
      const tv=composeTVListino(sel,nf);
      const total=Number((wifiBest.priceValue+tv.subtotal).toFixed(2));
      const voceKey=state.voce||'consumo';
      const best={ id:'LIST_3P', name:`Composizione listino: ${wifiBest.name} + Sky TV`, priceValue:total, totalValue:total,
        attivazione:(wifiBest.attivazione||'-')+' + Stream 19€',
        codice:(wifiBest.codiceVoce?(wifiBest.codiceVoce[voceKey]||Object.values(wifiBest.codiceVoce)[0]):'—'),
        scadenza:wifiBest.scadenza||'—', durata:'—', note:'Composizione WiFi promo + TV a listino.',
        breakdown:[`${wifiBest.name} ${wifiBest.priceValue.toFixed(2)}€`].concat(tv.breakdown), extraMonthly:0};
      return {best}
    }
    if(off==='wifi'){
      const wifiBest=PROMO.wifi[1]||PROMO.wifi[0];
      const voceKey=state.voce||'consumo';
      const best={...wifiBest};
      best.totalValue=wifiBest.priceValue; best.codice= wifiBest.codiceVoce? (wifiBest.codiceVoce[voceKey]||Object.values(wifiBest.codiceVoce)[0]):'—'; best.extraMonthly=0;
      return {best}
    }
    return {error:'Nessuna combinazione disponibile.'}
  }

  function extractMonths(str){ if(!str) return null; const m = String(str).match(/(\d+)\s*mesi/i); return m ? parseInt(m[1],10) : null }
  function cap(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s }
  function sumExtrasFromBreakdown(breakdown){
    if(!breakdown || !breakdown.length) return 0;
    return breakdown.reduce((acc, item)=>{
      const m = String(item).replace(',','.').match(/([\d.]+)\s*€/);
      return acc + (m ? parseFloat(m[1]) : 0);
    },0);
  }
  function buildCompositionText(best){
    let base = best.includedNetflix ? `Sky TV + Netflix ${cap(best.includedNetflix)}` : 'Sky TV';
    const inc = new Set(best.included||[]);
    const order = ['sport','cinema','calcio','kids','uhd'];
    const map = {sport:'Sport',cinema:'Cinema',calcio:'Calcio',kids:'Kids',uhd:'UHD/4K'};
    order.forEach(p=>{ if(inc.has(p)) base += ` + ${map[p]}` });
    return base;
  }

  function renderResult(r){
    const noRes=qs('#noResult'), res=qs('#result'); if(r.error){ noRes.style.display='block'; noRes.textContent=r.error; res.style.display='none'; return }
    noRes.style.display='none'; res.style.display='block'
    const nameEl=qs('#bestName');
    const isGlass = r.best.id?.startsWith('GLASS_')

    if(r.best.isPromo && !String(r.best.id).startsWith('LIST_')){
      nameEl.innerHTML = `${r.best.name} <span class="badge" style="margin-left:8px">Promo del momento</span>${isGlass?` <span class="pill glass">GLASS incluso · 199€ una tantum</span>`:''}`
    } else if(String(r.best.id).startsWith('LIST_')) {
      nameEl.innerHTML = `${r.best.name} <span class="pill">Prezzo di listino</span>`
    } else { nameEl.textContent = r.best.name }

    const total = typeof r.best.totalValue==='number' ? r.best.totalValue : (r.best.priceValue||0)
    qs('#priceAmount').textContent = formatEUR(total)
    qs('#attivazione').textContent = r.best.attivazione || '-'
    qs('#codice').textContent = r.best.codice || '-'
    qs('#scadenza').textContent = r.best.scadenza || '-'
    qs('#glassKpi').style.display = isGlass ? 'block' : 'none'

    const fBox = qs('#formulaBox');
    if(r.best.breakdown && r.best.breakdown.length){ fBox.style.display='inline-block'; fBox.innerHTML = `<b>Formula:</b> ${r.best.breakdown.join(' + ')} = <b>${formatEUR(total)}</b>` } else { fBox.style.display='none' }

    const priceDet = qs('#priceDetail');
    let baseSentence = '';
    if(r.best.isPromo && r.best.price){ baseSentence = `Promo base: ${r.best.price}${r.best.durata?` per ${r.best.durata}`:''}` }
    else if(String(r.best.id).startsWith('LIST_')){ baseSentence = 'Prezzo di listino (Smart)' }
    const addSentence = (r.best.breakdown && r.best.breakdown.length) ? `Aggiunte: ${r.best.breakdown.join(' + ')} al mese` : ''
    const glassSentence = isGlass ? 'DISPOSITIVO INCLUSO: SKY GLASS 43" Nero – costo una tantum 199€ (consegna gratuita).' : ''
    priceDet.textContent = [baseSentence, glassSentence, addSentence].filter(Boolean).join(' · ')

    const comp = (r.best.breakdown && r.best.breakdown.length) ? `<br/><b>Voci aggiunte:</b> ${r.best.breakdown.join(' + ')}` : ''
    const glassNote = isGlass ? ' · SKY GLASS 43" Nero incluso nel bundle · 199€ una tantum.' : ''
    qs('#note').innerHTML = `<b>Note:</b> ${r.best.note||'-'}${glassNote}${r.best.durata?` · Durata promo: ${r.best.durata}`:''}${comp}`

    const recap = qs('#recapBox');
    const compText = buildCompositionText(r.best);
    const extrasSum = r.best.extraMonthly ?? sumExtrasFromBreakdown(r.best.breakdown);
    const att = r.best.attivazione || '—';
    let durata = extractMonths(r.best.durata) || extractMonths(r.best.price) || (String(r.best.id).startsWith('WIFI') ? 12 : 18);
    let vincolo = (String(r.best.id).startsWith('WIFI') ? 12 : 18);
    recap.innerHTML = `
      <h4>Composizione offerta</h4>
      <div class="recap-grid">
        <div class="recap-label">Sky TV / Bundle</div>
        <div class="recap-value">${compText}</div>

        <div class="recap-label">+ Pacchetti / Opzioni</div>
        <div class="recap-value">${extrasSum>0?`+${formatEUR(extrasSum)}`:'—'}</div>

        <div class="recap-label">Dispositivo</div>
        <div class="recap-value">${isGlass ? 'SKY GLASS 43&quot; Nero (incluso) · 199€ una tantum' : '—'}</div>

        <div class="recap-label">Attivazione</div>
        <div class="recap-value">${att}</div>

        <div class="recap-label">Vincolo (mesi)</div>
        <div class="recap-value">${vincolo}</div>

        <div class="recap-label">Durata offerta (mesi)</div>
        <div class="recap-value">${durata}</div>
      </div>
      <div class="recap-badges">
        ${r.best.isPromo?'<span class="badge">Promo del momento</span>':''}
        ${isGlass?'<span class="pill glass">GLASS incluso · 199€</span>':''}
        ${(r.best.breakdown&&r.best.breakdown.length)?`<span class="badge">Formula: ${r.best.breakdown.join(' + ')}</span>`:''}
      </div>
    `;
    recap.style.display='block';

    const altBox = qs('#wifiAlternatives'); altBox.style.display='none'; altBox.innerHTML='';
    qs('#contractCta').style.display = 'block';
  }

  qs('#calcBtn').addEventListener('click', ()=> renderResult(computeBest()))
  qs('#resetBtn').addEventListener('click', ()=> location.reload())
  qs('#copyCode').addEventListener('click', ()=>{ const code=qs('#codice').textContent.trim(); if(!code||code==='-') return; navigator.clipboard.writeText(code) })

  /* ===== COSTI DI RECESSO ===== */
  const COSTI_RECESSO = {
    tv:  [10.10,20.20,30.30,40.40,50.50,50.50,50.50,50.50,50.50,50.50,50.50,50.50,50.50,40.40,30.30,20.20,10.10,0.00],
    tv1: [14.10,28.20,42.30,56.40,70.50,70.50,70.50,70.50,70.50,70.50,70.50,70.50,70.50,56.40,42.30,28.20,14.10,0.00],
    tv2: [18.10,36.20,54.30,72.40,90.50,90.50,90.50,90.50,90.50,90.50,90.50,90.50,90.50,72.40,54.30,36.20,18.10,0.00],
    tv3: [22.10,44.20,66.30,88.40,110.50,110.50,110.50,110.50,110.50,110.50,110.50,110.50,110.50,88.40,66.30,44.20,22.10,0.00],
  };

  /* --- FIX RECESSO: delegazione click, funziona a prescindere dall'ordine script/HTML --- */
document.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('#calcRecesso');
  if(!btn) return;

  const meseSel = parseInt(qs('#mesiTrascorsi').value,10);
  const packSel = qs('#nPacchetti').value;
  if(!meseSel || !packSel){ alert('Seleziona mese e configurazione pacchetti.'); return; }

  const arr = COSTI_RECESSO[packSel] || [];
  const idx = Math.min(Math.max(meseSel,1),18)-1;
  const valore = arr[idx] ?? 0;

  const box = qs('#resRecesso');
  qs('#totRecesso').textContent = formatEUR(valore);
  box.style.display='block';
  box.classList.remove('pulse'); void box.offsetWidth; box.classList.add('pulse');
  box.scrollIntoView({behavior:'smooth', block:'center'});

  const labelPack = {tv:'Sky TV', tv1:'Sky TV + 1 pack', tv2:'Sky TV + 2 pack', tv3:'Sky TV + 3 pack'}[packSel];
  qs('#detailRecesso').textContent = `Mese ${meseSel}° · Configurazione: ${labelPack} · Valore tabellare: ${formatEUR(valore)}.`;
});

  /* Dataset dialog */
  const datasetDlg=qs('#datasetDlg')
  qs('#listinoBtn').addEventListener('click', ()=>{
    const DATA={PACCHETTI:LISTINO.base.pacchetti, NETFLIX:LISTINO.base.netflix, PROMO};
    qs('#datasetPre').textContent = JSON.stringify(DATA,null,2); datasetDlg.showModal()
  })
})();
</script>

<!-- Sezione Recesso + Dataset dialog -->
<details class="result-card" style="margin-top:16px">
  <summary class="btn" style="list-style:none;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
    Calcolo costi di recesso (Privato) <span class="muted">clicca per aprire</span>
  </summary>
  <div style="padding-top:12px">
    <div class="row">
      <div>
        <label>Mesi trascorsi dall'attivazione</label>
        <select id="mesiTrascorsi">
          <option value="" selected disabled>Seleziona mese…</option>
          <option value="1">1°</option><option value="2">2°</option><option value="3">3°</option>
          <option value="4">4°</option><option value="5">5°</option><option value="6">6°</option>
          <option value="7">7°</option><option value="8">8°</option><option value="9">9°</option>
          <option value="10">10°</option><option value="11">11°</option><option value="12">12°</option>
          <option value="13">13°</option><option value="14">14°</option><option value="15">15°</option>
          <option value="16">16°</option><option value="17">17°</option><option value="18">18°</option>
        </select>
      </div>
      <div>
        <label>Numero pacchetti TV attivi</label>
        <select id="nPacchetti">
          <option value="" selected disabled>Seleziona configurazione…</option>
          <option value="tv">Sky TV</option>
          <option value="tv1">Sky TV + 1 pack</option>
          <option value="tv2">Sky TV + 2 pack</option>
          <option value="tv3">Sky TV + 3 pack</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div class="muted">I valori corrispondono al grafico ufficiale. Seleziona mese e configurazione, poi calcola.</div>
      <div style="text-align:right"><button class="btn" id="calcRecesso">Calcola recesso</button></div>
    </div>
    <div class="result-card" id="resRecesso" style="display:none;margin-top:12px">
      <div class="result-head">
        <div class="result-name">Totale recesso</div>
        <div class="kpi"><b id="totRecesso">€ 0,00</b></div>
      </div>
      <div class="notes" id="detailRecesso"></div>
    </div>
  </div>
</details>

<dialog id="datasetDlg" style="border:none;border-radius:16px;max-width:920px;width:92%;background:#ffffff;color:#111827;">
  <div style="padding:18px 18px 8px 18px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)">
    <b>Dataset promo (interno) · v4.3</b>
    <button class="btn secondary" onclick="this.closest('dialog').close()">Chiudi</button>
  </div>
  <div style="padding:14px 18px 22px 18px;max-height:60vh;overflow:auto">
    <pre id="datasetPre" style="white-space:pre-wrap;font-size:12px;line-height:1.35;background:#fafcff;border:1px solid var(--border);padding:12px;border-radius:12px"></pre>
    <div class="muted" style="margin-top:8px">Nota: i dati sono inseriti direttamente nel codice.</div>
  </div>
</dialog>
</div>
</body>
</html>
        
